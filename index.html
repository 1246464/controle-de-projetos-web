<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Controle de Projetos Completo</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f0f8f0;
            color: #333;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 100%;
            flex: 1;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 6px 30px rgba(0,0,0,.08);
            overflow: hidden;
            margin: 10px;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: #fff;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .logo i {
            font-size: 2.2rem;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            padding: 16px;
            background: #e8f5e9;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .summary-card {
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,.04);
            border-left: 4px solid #4caf50;
        }
        
        .summary-card-efficiency {
            border-left: 4px solid #2196f3 !important;
        }
        
        .summary-card-cancelado {
            border-left: 4px solid #9e9e9e !important;
        }
        
        .summary-card-espera {
            border-left: 4px solid #ff9800 !important;
        }
        
        .filters-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .filters-collapsible.show {
            max-height: 1000px;
        }
        
        .controls {
            padding: 16px;
            background: #e8f5e9;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-start;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .filters-section {
            flex: 1;
            min-width: 300px;
        }
        
        .filters-title {
            font-weight: 700;
            font-size: 1rem;
            color: #2e7d32;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filters-title i {
            font-size: 1.1rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #444;
        }
        
        .filter-group input, .filter-group select {
            padding: 10px 12px;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            background: #fff;
            font-size: 0.9rem;
            transition: border 0.2s;
        }
        
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.1);
        }
        
        /* Estilo para selects múltiplos */
        select[multiple] {
            min-height: 100px;
            max-height: 150px;
            padding: 8px;
        }
        
        .date-filter-section {
            flex: 1;
            min-width: 300px;
            background: #f1f8e9;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        
        .date-filter-title {
            font-weight: 700;
            font-size: 1rem;
            color: #2e7d32;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .date-range-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .date-range-inputs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .btn-primary { background: #2e7d32; color: #fff; }
        .btn-success { background: #4caf50; color: #fff; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-info { background: #00bcd4; color: #fff; }
        .btn-warning { background: #ff9800; color: #fff; }
        .btn-sm { padding: 6px 10px; font-size: .85rem; }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* ALTERAÇÃO: Aumentar altura da tabela para mostrar mais linhas */
        .table-container {
            overflow-x: auto;
            padding: 10px;
            flex: 1;
            max-height: 70vh; /* Aumentado de 40vh para 70vh */
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #2e7d32;
            color: #fff;
            position: sticky;
            top: 0;
            font-weight: 700;
            white-space: nowrap;
        }
        
        tr:nth-child(even) { background: #fbfbfb; }
        
        tr:hover {
            background-color: #f0f9f0 !important;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            color: #000 !important;
            min-width: 90px;
            text-align: center;
        }
        
        .status-pendente { background: #ff9800; }
        .status-em-andamento { background: #2196f3; }
        .status-concluido { background: #4caf50; }
        .status-atrasado { background: #f44336; }
        .status-no-prazo { background: #4caf50; }
        .status-em-espera { background: #ff9800; }
        .status-cancelado { background: #9e9e9e; }
        
        .form-container {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,.06);
            margin: 16px 20px;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #c8e6c9;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #333;
            font-size: .9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 12px 0;
            z-index: 10;
            border-top: 1px solid #eee;
        }
        
        .task-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .history-badge {
            background: #6c757d;
            color: #fff;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: .75rem;
            cursor: pointer;
            margin-right: 5px;
            border: none;
        }
        
        .reschedule-btn {
            background: #6c757d;
            color: #fff;
            padding: 5px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: .85rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.45);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background: #fff;
            margin: 4% auto;
            padding: 20px;
            border-radius: 10px;
            width: 92%;
            max-width: 900px;
            max-height: 80vh;
            overflow: auto;
            position: relative;
            border: 1px solid #4caf50;
        }
        
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }
        
        .task-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .task-table th, .task-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .task-table th {
            background: #2e7d32;
            color: #fff;
        }
        
        .task-table input[type="date"], .task-table input[type="text"], .task-table select, .task-table input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .date-group {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .date-group-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
            display: block;
        }
        
        .task-header {
            background: #e8f5e9;
            font-weight: bold;
        }
        
        .task-row {
            background: #f8f9fa;
        }
        
        .task-actions {
            padding: 8px;
            text-align: left;
            background: #f1f8e9;
        }
        
        .filter-status-count {
            font-weight: bold;
            color: #2e7d32;
            margin-left: 8px;
            background: #e8f5e9;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .resource-group {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .resource-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            display: block;
        }

        .task-group-divider {
            height: 20px;
            background-color: #e8f5e9;
            position: relative;
            margin: 15px 0;
            border-left: 4px solid #2e7d32;
        }
        
        .task-group-divider::before {
            content: attr(data-task-name);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #2e7d32;
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .task-group {
            margin-bottom: 25px;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .task-group-header {
            background: #2e7d32;
            color: white;
            padding: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-group-content {
            padding: 20px;
        }
        
        .column-group {
            border-right: 2px solid #2e7d32 !important;
            background-color: #f1f8e9 !important;
        }
        
        .column-group-header {
            background: #1b5e20 !important;
            text-align: center;
            font-size: 0.9rem;
        }

        .resource-section {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .resource-section h4 {
            margin: 0 0 12px 0;
            color: #2e7d32;
            font-size: 0.9rem;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            background: #e3f2fd;
            color: #0d47a1;
        }

        .sync-indicator.syncing {
            background: #fff8e1;
            color: #f57f17;
        }

        .sync-indicator.error {
            background: #ffebee;
            color: #c62828;
        }

        .charts-section {
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #c8e6c9;
            display: none;
        }
        
        .charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #2e7d32;
            font-weight: 600;
            text-align: center;
        }
        
        .chart-filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .chart-filters select, .chart-filters input {
            padding: 8px 12px;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            background: #fff;
        }

        /* CORREÇÃO: Cards de eficiência acima dos gráficos - MELHORIA */
        .charts-efficiency-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            order: 1;
            width: 100%;
        }
        
        .charts-container {
            order: 2;
        }
        
        .chart-section-group {
            display: block;
        }
        
        .chart-section-group .summary-card {
            margin-bottom: 15px;
        }

        .project-detail-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-detail-item:hover {
            background-color: #f5f5f5;
        }

        .project-detail-info {
            flex: 1;
        }

        .project-detail-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 992px) {
            .filters-grid, .date-filter-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .controls { 
                flex-direction: column; 
                gap: 20px;
            }
            
            .filters-section, .date-filter-section {
                width: 100%;
            }
            
            .filters-grid, .date-filter-grid {
                grid-template-columns: 1fr;
            }
            
            .header-buttons { 
                justify-content: flex-start; 
                margin-top: 10px; 
                width: 100%;
            }
            
            .task-table {
                font-size: 0.7rem;
            }
            
            .task-table input[type="date"], .task-table input[type="text"], .task-table select, .task-table input[type="number"] {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .task-group-divider::before {
                font-size: 0.8rem;
                padding: 1px 6px;
            }
            
            .chart-filters {
                grid-template-columns: 1fr;
            }
            
            .chart-section-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* MELHORIA: Ajuste para cards de eficiência em mobile */
            .charts-efficiency-cards {
                grid-template-columns: 1fr;
            }
            
            /* Ajuste para selects múltiplos em mobile */
            select[multiple] {
                min-height: 80px;
                max-height: 120px;
            }
        }

        @media (max-width: 480px) {
            .task-table {
                display: block;
                overflow-x: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    
        /* Congelar colunas até Observações */
        .table-container th.sticky, 
        .table-container td.sticky {
            position: sticky;
            background: #fff;
            z-index: 5;
        }

        th.col-id, td.col-id { left: 0;  min-width: 60px; z-index: 6; }
        th.col-cliente, td.col-cliente { left: 60px; min-width: 150px; }
        th.col-projeto, td.col-projeto { left: 210px; min-width: 180px; }
        th.col-segmento, td.col-segmento { left: 390px; min-width: 120px; }
        th.col-lider, td.col-lider { left: 510px; min-width: 150px; }
        th.col-codigo, td.col-codigo { left: 660px; min-width: 100px; }
        th.col-modelo, td.col-modelo { left: 760px; min-width: 120px; }
        th.col-processo, td.col-processo { left: 880px; min-width: 120px; }
        th.col-fase, td.col-fase { left: 1000px; min-width: 100px; }
        th.col-status, td.col-status { left: 1100px; min-width: 130px; }
        th.col-observacoes, td.col-observacoes { left: 1230px; min-width: 200px; }

        /* Novos estilos para botões de sincronização */
        #syncFiltersBtn, #useTablePeriodBtn {
            background: #17a2b8;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        #useTablePeriodBtn {
            background: #ff9800;
        }

        #useTablePeriodBtn:hover {
            background: #e68900;
        }

        .chart-period-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #2e7d32;
        }

        /* Cards de eficiência do período */
        .period-efficiency-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        /* CORREÇÃO: Ajuste para o modal de status */
        #projectStatusModal .project-detail-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #projectStatusModal .project-detail-item:hover {
            background-color: #f5f5f5;
        }

        #projectStatusModal .project-detail-info {
            flex: 1;
        }

        #projectStatusModal .project-detail-actions {
            display: flex;
            gap: 5px;
        }

        /* NOVO: Melhoria para garantir que os cards fiquem sempre acima */
        .charts-efficiency-section {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .charts-section {
            display: flex;
            flex-direction: column;
        }

        /* MELHORIA: Para informações de projeto no modal */
        .project-task-status {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .project-task-status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .project-task-status-label {
            font-weight: bold;
            color: #666;
        }
        
        .project-task-status-value {
            font-weight: 600;
        }

        /* Estilos para os labels dentro das barras */
        .chartjs-plugin-datalabels {
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        /* NOVO: Estilos para o modal de lista de projetos */
        #projectListModal .modal-content {
            max-width: 90%;
            max-height: 85vh;
        }

        #projectListModal .task-table {
            margin-top: 15px;
            font-size: 0.85rem;
        }

        #projectListModal .task-table th,
        #projectListModal .task-table td {
            padding: 10px;
            text-align: left;
        }

        #projectListModal .task-table th {
            background: #2e7d32;
            color: white;
            position: sticky;
            top: 0;
        }

        #projectListModal .task-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        /* NOVO: Botões para seleção múltipla de status */
        .multi-select-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .multi-select-btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .multi-select-btn:hover {
            background: #e0e0e0;
        }
        
        /* Melhorias visuais para os filtros */
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .filter-actions .btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        /* Indicador de contagem de projetos filtrados */
        .projects-count {
            background: #2e7d32;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* NOVO: Estilo para o contador de filtro de tarefa */
        .task-filter-count-container {
            margin-top: 12px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .task-filter-count-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #2e7d32;
        }
        
        .task-filter-count-label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .task-filter-count-value {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1rem;
            min-width: 40px;
            text-align: center;
        }

        /* NOVO: Estilos para histórico editável */
        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:hover {
            background: #f0f0f0;
        }
        
        .history-item-content {
            flex: 1;
            margin-right: 12px;
        }
        
        .history-item-date {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 4px;
        }
        
        .history-item-reason {
            color: #555;
            margin-bottom: 4px;
        }
        
        .history-item-dates {
            font-size: 0.85rem;
            color: #666;
        }
        
        .history-item-actions {
            display: flex;
            gap: 4px;
        }
        
        .history-edit-form {
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #4caf50;
            border-radius: 6px;
            background: #e8f5e9;
        }
        
        .history-form-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }

    </style>
</head>
<body>
<div class="container">
<header>
<div class="logo">
<i class="fas fa-project-diagram"></i>
<div>
<h1 style="font-size:1.2rem;margin-bottom:4px">Controle de Projetos Completo</h1>
<div style="font-size:.85rem;opacity:.9">Gestão de projetos avec múltiplos líderes</div>
</div>
</div>
<div class="header-buttons">
<button class="btn btn-primary" id="addProjectBtn"><i class="fas fa-plus"></i> Novo Projeto</button>
<button class="btn btn-info" id="manageLeadersBtn"><i class="fas fa-users"></i> Gerenciar Líderes</button>
<button class="btn btn-success" id="saveDataBtn"><i class="fas fa-save"></i> Salvar Dados</button>
<button class="btn btn-warning" id="loadDataBtn"><i class="fas fa-download"></i> Carregar Dados</button>
<button class="btn btn-primary" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Exportar Excel</button>
<button class="btn btn-info" id="importExcelBtn"><i class="fas fa-file-import"></i> Importar Excel</button>
<button class="btn btn-info" id="sharedFileBtn"><i class="fas fa-network-wired"></i> Arquivo Compartilhado</button>
<button class="btn btn-warning" id="syncBtn"><i class="fas fa-sync"></i> Sincronizar</button>
<button class="btn btn-info" id="showChartsBtn"><i class="fas fa-chart-bar"></i> Gráficos</button>
<button class="btn btn-info" id="toggleFiltersBtn"><i class="fas fa-filter"></i> Filtros</button>
</div>
</header>
<div class="summary">
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">Total de Projetos</h3><p id="totalProjects">0</p></div>
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">No Prazo</h3><p id="onTimeProjects">0</p></div>
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">Atrasados</h3><p id="delayedProjects">0</p></div>
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">Concluídos</h3><p id="completedProjects">0</p></div>
<div class="summary-card summary-card-espera"><h3 style="font-size:.85rem;color:#666">Em Espera</h3><p id="onHoldProjects">0</p></div>
<div class="summary-card summary-card-cancelado"><h3 style="font-size:.85rem;color:#666">Cancelados</h3><p id="cancelledProjects">0</p></div>
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">Líderes Cadastrados</h3><p id="totalLeaders">0</p></div>
<div class="summary-card"><h3 style="font-size:.85rem;color:#666">Status Sincronização</h3><p id="syncStatus">Offline</p></div>
<!-- Novos cards de eficiência -->
<div class="summary-card summary-card-efficiency"><h3 style="font-size:.85rem;color:#666">Eficiência das Tarefas</h3><p id="tasksEfficiency">0%</p></div>
<div class="summary-card summary-card-efficiency"><h3 style="font-size:.85rem;color:#666">Eficiência de Projetos</h3><p id="projectsEfficiency">0%</p></div>
</div>

<!-- REMOVIDO: Botão duplicado para mostrar/ocultar filtros (apenas o do cabeçalho permanece) -->

<!-- Seção de filtros (inicialmente oculta) -->
<div class="filters-collapsible" id="filtersContainer">
<div class="controls">
<!-- Filtros principais -->
<div class="filters-section">
<div class="filters-title"><i class="fas fa-filter"></i> Filtros de Projetos</div>
<div class="filters-grid">
<div class="filter-group">
<label for="idFilter">ID do Projeto</label>
<input id="idFilter" placeholder="Digite o ID"/>
</div>
<div class="filter-group">
<label for="projectFilter">Nome do Projeto</label>
<input id="projectFilter" placeholder="Digite o nome"/>
</div>
<div class="filter-group">
<label for="segmentoFilter">Segmento</label>
<select id="segmentoFilter">
<option value="todos">Todos os Segmentos</option>
<option>Blindados</option><option>Autos</option><option>Agrícola</option><option>Ônibus &amp; Caminhões</option><option>Trens</option>
</select>
</div>
<div class="filter-group">
<label for="leaderFilter">Líder</label>
<select id="leaderFilter"><option value="todos">Todos os Líderes</option></select>
</div>
<div class="filter-group">
<label for="statusFilter">Status do Projeto</label>
<select id="statusFilter" multiple size="3">
<option value="Pendente">Pendente</option>
<option value="Em Andamento">Em Andamento</option>
<option value="No Prazo">No Prazo</option>
<option value="Atrasado">Atrasado</option>
<option value="Concluído">Concluído</option>
<option value="Em Espera">Em Espera</option>
<option value="Cancelado">Cancelado</option>
</select>
<div class="multi-select-controls">
<button class="multi-select-btn" onclick="selectAllStatuses()">Selecionar Todos</button>
<button class="multi-select-btn" onclick="clearAllStatuses()">Limpar</button>
</div>
</div>
<div class="filter-group">
<label for="search">Pesquisa Geral</label>
<input id="search" placeholder="Pesquisar..."/>
</div>
</div>
<div class="filter-actions">
<button class="btn btn-primary btn-sm" onclick="updateProjectsTable(); updateSummary();"><i class="fas fa-filter"></i> Aplicar Filtros</button>
<button class="btn btn-danger btn-sm" onclick="clearAllFilters()"><i class="fas fa-times"></i> Limpar Tudo</button>
</div>
</div>

<!-- Filtros por tarefa -->
<div class="date-filter-section">
<div class="date-filter-title"><i class="fas fa-tasks"></i> Filtros por Tarefa</div>
<div class="date-filter-grid">
<div class="filter-group">
<label for="dateFilterType">Tipo de Tarefa</label>
<select id="dateFilterType">
<option value="todos">Todas as Tarefas</option>
<option value="kom">KOM</option>
<option value="ferramental">Ferramental</option>
<option value="cadBomFt">CAD+BOM+FT</option>
<option value="tryout">Try-out</option>
<option value="entrega">Entrega</option>
<option value="psw">PSW</option>
<option value="handover">Handover</option>
</select>
</div>
<div class="filter-group">
<label for="taskSegmentoFilter">Segmento da Tarefa</label>
<select id="taskSegmentoFilter">
<option value="todos">Todos os Segmentos</option>
<option>Blindados</option><option>Autos</option><option>Agrícola</option><option>Ônibus &amp; Caminhões</option><option>Trens</option>
</select>
</div>
<div class="filter-group">
<label for="taskLeaderFilter">Líder da Tarefa</label>
<select id="taskLeaderFilter"><option value="todos">Todos os Líderes</option></select>
</div>
<div class="filter-group">
<label for="taskStatusFilter">Status da Tarefa</label>
<select id="taskStatusFilter" multiple size="3">
<option value="Pendente">Pendente</option>
<option value="Em Andamento">Em Andamento</option>
<option value="No Prazo">No Prazo</option>
<option value="Atrasado">Atrasado</option>
<option value="Concluído">Concluído</option>
<option value="Cancelado">Cancelado</option>
<option value="Em Espera">Em Espera</option>
</select>
<div class="multi-select-controls">
<button class="multi-select-btn" onclick="selectAllTaskStatuses()">Selecionar Todos</button>
<button class="multi-select-btn" onclick="clearAllTaskStatuses()">Limpar</button>
</div>
</div>
<div class="filter-group">
<label>Período da Tarefa</label>
<div class="date-range-inputs">
<input id="dateFilterFrom" type="date" placeholder="De"/>
<input id="dateFilterTo" type="date" placeholder="Até"/>
</div>
</div>
</div>

<!-- NOVA SEÇÃO: Contador de projetos filtrados por tarefa -->
<div class="task-filter-count-container" id="taskFilterCountContainer" style="display: flex;">
    <div class="task-filter-count-item">
        <span class="task-filter-count-label">Projetos filtrados:</span>
        <span class="task-filter-count-value" id="taskFilterCountTotal">0</span>
    </div>
    <div class="task-filter-count-item">
        <span class="task-filter-count-label">Por status selecionado:</span>
        <span class="task-filter-count-value" id="taskFilterCountByStatus">0</span>
    </div>
    <div class="task-filter-count-item">
        <span class="task-filter-count-label">Por segmento selecionado:</span>
        <span class="task-filter-count-value" id="taskFilterCountBySegment">0</span>
    </div>
    <div class="task-filter-count-item">
        <span class="task-filter-count-label">Por líder selecionado:</span>
        <span class="task-filter-count-value" id="taskFilterCountByLeader">0</span>
    </div>
</div>

<div class="filter-actions">
<button class="btn btn-primary btn-sm" id="applyDateFilterBtn"><i class="fas fa-filter"></i> Aplicar Filtro</button>
<button class="btn btn-danger btn-sm" id="clearDateFilterBtn"><i class="fas fa-times"></i> Limpar</button>
<span class="filter-status-count" id="taskStatusCount" style="display:none">
                    <i class="fas fa-project-diagram"></i> Projetos: <span id="taskStatusCountValue">0</span>
</span>
</div>
</div>
</div>
</div>

<!-- Formulário Projeto -->
<div aria-hidden="true" class="form-container" id="projectForm">
<h2 id="formTitle">Novo Projeto</h2>
<div class="form-grid">
<div class="form-group"><label>Cliente</label><input id="cliente"/></div>
<div class="form-group"><label>Projeto</label><input id="projectName"/></div>

<!-- Project status (manual or automatic) -->
<div class="form-group">
<label for="projectStatusSelect">Status do Projeto</label>
<select id="projectStatusSelect">
<option selected="" value="automatico">Automático</option>
<option value="em espera">Em Espera</option>
<option value="cancelado">Cancelado</option>
</select>
<small style="display:block; margin-top:4px; color:#666; font-size:0.8rem">Escolha Automático para que o status seja calculado conforme as tarefas.</small>
</div>

<div class="form-group"><label>Segmento</label>
<select id="segmento">
<option value="">--</option><option>Blindados</option><option>Autos</option><option>Agrícola</option><option>Ônibus &amp; Caminhões</option><option>Trens</option>
</select>
</div>
<div class="form-group"><label>Líder</label><select id="projectLeader"><option value="">Selecione</option></select></div>
<div class="form-group"><label>Código</label><input id="codigo"/></div>
<div class="form-group"><label>Modelo</label>
<select id="modelo">
<option value="">--</option>
<option>PBS</option><option>PBE</option><option>PBD</option>
<option>QDE</option><option>QDD</option>
<option>FDE</option><option>FDD</option>
<option>PDE</option><option>PDD</option>
<option>PTE</option><option>PTD</option><option>PTBE</option><option>PTBD</option>
<option>FTE</option><option>FTD</option>
<option>QTE</option><option>QTD</option>
<option>VGA</option>
<option>TSP</option><option>TSA</option><option>TSB</option><option>TSC</option>
<option>OLS</option>
<option>OUTROS</option>
</select>
</div>
<div class="form-group"><label>Processo</label>
<select id="processo">
<option value="">--</option>
<option>Laminado</option><option>Temperado</option><option>Blindado</option><option>Insulado</option>
</select>
</div>
<div class="form-group"><label>Fase</label><select id="fase"><option value="">--</option><option>Protótipo</option><option>Série</option></select></div>
<div class="form-group" style="grid-column:1/-1"><label>Observações</label><textarea id="observacoes" rows="3"></textarea></div>
</div>
<h3 style="margin-top:20px;padding-bottom:8px;border-bottom:2px solid #2e7d32">Datas das Tarefas</h3>
<p style="font-size:0.9rem;color:#666;margin-bottom:16px">Defina as datas planejadas and de execução para cada tarefa do projeto.</p>
<!-- KOM -->
<div class="task-group">
<div class="task-group-header">
<span>KOM - Kick-off Meeting</span>
<span class="status" id="komStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="komPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="komPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="komStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="komExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'kom')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'kom')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- FERRAMENTAL -->
<div class="task-group">
<div class="task-group-header">
<span>FERRAMENTAL - Desenvolvimento and preparação de ferramentais</span>
<span class="status" id="ferramentalStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="ferramentalPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="ferramentalPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="ferramentalStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="ferramentalExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'ferramental')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'ferramental')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
<div class="resource-section">
<h4>Recursos do Ferramental</h4>
<div class="form-grid">
<div class="form-group">
<label>Fêmea:</label>
<input id="ferramentalFemea" type="date"/>
</div>
<div class="form-group">
<label>Gabarito Fanavid:</label>
<input id="ferramentalGabaritoFanavid" type="date"/>
</div>
<div class="form-group">
<label>Gabarito Usinado:</label>
<input id="ferramentalGabaritoUsinado" type="date"/>
</div>
<div class="form-group">
<label>Matriz:</label>
<input id="ferramentalMatriz" type="date"/>
</div>
<div class="form-group">
<label>Macho:</label>
<input id="ferramentalMacho" type="date"/>
</div>
<div class="form-group">
<label>Template:</label>
<input id="ferramentalTemplate" type="date"/>
</div>
<div class="form-group">
<label>Chapelona:</label>
<input id="ferramentalChapelona" type="date"/>
</div>
<div class="form-group">
<label>Plotter:</label>
<input id="ferramentalPlotter" type="date"/>
</div>
<div class="form-group">
<label>Tela:</label>
<input id="ferramentalTela" type="date"/>
</div>
</div>
</div>
</div>
</div>
<!-- CAD+BOM+FT -->
<div class="task-group">
<div class="task-group-header">
<span>CAD+BOM+FT - Projeto CAD, Lista de Materiais (BOM) and Folha de Tempos (FT)</span>
<span class="status" id="cadBomFtStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="cadBomFtPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="cadBomFtPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="cadBomFtStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="cadBomFtExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'cadBomFt')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'cadBomFt')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- TRY-OUT -->
<div class="task-group">
<div class="task-group-header">
<span>TRY-OUT - Testes e ajustes dos ferramentais</span>
<span class="status" id="tryoutStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<div class="form-grid">
<div class="form-group">
<label>Número do Try-out:</label>
<input id="tryoutNumber" placeholder="Número" type="text"/>
</div>
<div class="form-group">
<label>Quantidade de Entrada de Peças:</label>
<input id="tryoutQuantidadeEntrada" type="number" min="0" step="1" placeholder="0"/>
</div>
<div class="form-group">
<label>Quantidade de Saída de Peças:</label>
<input id="tryoutQuantidadeSaida" type="number" min="0" step="1" placeholder="0"/>
</div>
</div>
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="tryoutPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="tryoutPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="tryoutStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="tryoutExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'tryout')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'tryout')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
<div class="resource-section">
<h4>Recursos do Try-out</h4>
<div class="form-grid">
<div class="form-group">
<label>Corte:</label>
<select id="tryoutCorte">
<option value="">-- Selecione --</option>
<option>Bottero</option>
<option>Bottero+ Bystronic 02</option>
<option>Bottero+ Bystronic 04</option>
<option>Bottero+ Bystronic 05</option>
<option>Bottero+ Bystronic 06</option>
<option>Intermac - Jumbo</option>
</select>
</div>
<div class="form-group">
<label>Lapidação:</label>
<select id="tryoutLapidacao">
<option value="">-- Selecione --</option>
<option>Bystronic 02</option>
<option>Bystronic 04</option>
<option>Bystronic 05</option>
<option>Bystronic 06</option>
<option>Intermac 01 - P1</option>
<option>Intermac 02 - P1</option>
<option>Intermac 01 - P2</option>
<option>Lixa</option>
<option>Americana</option>
<option>Biseladora</option>
</select>
</div>
<div class="form-group">
<label>Furação / Rec:</label>
<select id="tryoutFuracao">
<option value="">-- Selecione --</option>
<option>Bystronic 02 + Intermac</option>
<option>Bystronic 05 + Intermac</option>
<option>Bystronic 05</option>
<option>Intermac + Toledo</option>
<option>Intermac</option>
<option>Toledo</option>
</select>
</div>
<div class="form-group">
<label>Montagem:</label>
<select id="tryoutMontagem">
<option value="">-- Selecione --</option>
<option>Autos</option>
<option>Arquitetura</option>
<option>Ônibus</option>
<option>Blindados</option>
</select>
</div>
<div class="form-group">
<label>Serigrafia:</label>
<select id="tryoutSerigrafia">
<option value="">-- Selecione --</option>
<option>Svécia</option>
<option>Cugher</option>
<option>Dip Tech</option>
<option>Manual</option>
</select>
</div>
<div class="form-group">
<label>Queima:</label>
<select id="tryoutQueima">
<option value="">-- Selecione --</option>
<option>F. Verical BLD</option>
<option>HTF</option>
</select>
</div>
<div class="form-group">
<label>Fornos:</label>
<select id="tryoutFornos">
<option value="">-- Selecione --</option>
<option>KBFO 1</option>
<option>KBFO 2</option>
<option>HTBS</option>
<option>HTF</option>
<option>ESU</option>
<option>MATRIX-P1</option>
<option>MATRIX-P2</option>
<option>GLASS ROBOT-P2</option>
<option>SCREEN MAX-P2</option>
<option>F1-P2</option>
<option>F2-P2</option>
<option>F3-P2</option>
<option>F4-P2</option>
<option>F6-P2</option>
<option>FB1-P2</option>
<option>FB2-P2</option>
<option>FB3-P2</option>
<option>F7-P2</option>
</select>
</div>
</div>
</div>
</div>
</div>
<!-- ENTREGA -->
<div class="task-group">
<div class="task-group-header">
<span>ENTREGA - Entrega do projeto</span>
<span class="status" id="entregaStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<div class="form-group">
<label>Número da Entrega:</label>
<input id="entregaNumber" placeholder="Número" type="text"/>
</div>
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="entregaPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="entregaPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="entregaStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="entregaExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'entrega')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'entrega')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- PSW -->
<div class="task-group">
<div class="task-group-header">
<span>PSW - Part Submission Warrant</span>
<span class="status" id="pswStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="pswPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="pswPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="pswStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="pswExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'psw')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'psw')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- HANDOVER -->
<div class="task-group">
<div class="task-group-header">
<span>HANDOVER - Transferência do projeto</span>
<span class="status" id="handoverStatusCell">Pendente</span>
</div>
<div class="task-group-content">
<table class="task-table">
<thead>
<tr class="task-header">
<th colspan="2">Datas Planejadas</th>
<th colspan="2">Datas de Execução</th>
<th style="color:black">Ações</th>
</tr>
<tr class="task-header">
<th>Planejado</th>
<th>Replanejado</th>
<th>Início</th>
<th>Conclusão</th>
<th>Histórico</th>
</tr>
</thead>
<tbody>
<tr class="task-row">
<td>
<div class="date-group">
<span class="date-group-label">Original</span>
<input id="handoverPlanned" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Atual</span>
<input id="handoverPlanned2" readonly="" style="background-color:#f0f0f0;" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Início</span>
<input id="handoverStart" type="date"/>
</div>
</td>
<td>
<div class="date-group">
<span class="date-group-label">Conclusão</span>
<input id="handoverExecuted" type="date"/>
</div>
</td>
<td class="task-actions">
<button class="history-badge" onclick="showHistoryModal(0, 'handover')">0</button>
<button class="reschedule-btn" onclick="openRescheduleModal(0, 'handover')"><i class="fas fa-calendar-alt"></i> Replanejar</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="form-buttons">
<button class="btn btn-danger" id="cancelProjectBtn">Cancelar</button>
<button class="btn btn-primary" id="saveProjectBtn">Salvar Projeto</button>
</div>
</div>
<!-- Formulário Líderes -->
<div aria-hidden="true" class="form-container" id="leadersForm">
<h2>Gerenciar Líderes</h2>
<div class="form-grid">
<div class="form-group"><label>Nome</label><input id="newLeaderName"/></div>
<div class="form-group"><label>Email</label><input id="newLeaderEmail" type="email"/></div>
<div class="form-group"><label>Departamento</label><input id="newLeaderDepartment"/></div>
</div>
<div class="form-buttons">
<button class="btn btn-danger" id="cancelLeaderBtn">Cancelar</button>
<button class="btn btn-primary" id="addLeaderBtn">Adicionar Líder</button>
</div>
<div style="margin-top:12px">
<h3>Líderes Cadastrados</h3>
<div id="leadersListContainer"></div>
</div>
</div>
<!-- Seção de Gráficos -->
<div class="charts-section" id="chartsSection">
<div class="charts-header">
<h2>Gráficos de Eficiência</h2>
<button class="btn btn-danger" id="closeChartsBtn"><i class="fas fa-times"></i> Fechar Gráficos</button>
</div>

<!-- NOVOS FILTROS BASEADOS EM TAREFAS -->
<div class="chart-filters">
    <!-- Filtrar por Tarefa -->
    <div class="filter-group">
        <label for="chartTaskFilter">Filtrar por Tarefa</label>
        <select id="chartTaskFilter">
            <option value="todos">Todas as Tarefas</option>
            <option value="kom">KOM</option>
            <option value="ferramental">Ferramental</option>
            <option value="cadBomFt">CAD+BOM+FT</option>
            <option value="tryout">Try-out</option>
            <option value="entrega">Entrega</option>
            <option value="psw">PSW</option>
            <option value="handover">Handover</option>
        </select>
    </div>
    
    <!-- Segmento -->
    <div class="filter-group">
        <label for="chartSegment">Segmento</label>
        <select id="chartSegment">
            <option value="todos">Todos</option>
            <option>Blindados</option>
            <option>Autos</option>
            <option>Agrícola</option>
            <option>Ônibus &amp; Caminhões</option>
            <option>Trens</option>
        </select>
    </div>
    
    <!-- Período: De -->
    <div class="filter-group">
        <label for="chartDateFrom">De período</label>
        <input id="chartDateFrom" type="date"/>
    </div>
    
    <!-- Período: Até -->
    <div class="filter-group">
        <label for="chartDateTo">Até período</label>
        <input id="chartDateTo" type="date"/>
    </div>
    
    <!-- Status da Tarefa -->
    <div class="filter-group">
        <label for="chartTaskStatus">Status da Tarefa</label>
        <select id="chartTaskStatus" multiple size="3">
            <option value="Pendente">Pendente</option>
            <option value="Em Andamento">Em Andamento</option>
            <option value="No Prazo">No Prazo</option>
            <option value="Atrasado">Atrasado</option>
            <option value="Concluído">Concluído</option>
            <option value="Cancelado">Cancelado</option>
            <option value="Em Espera">Em Espera</option>
        </select>
        <div class="multi-select-controls">
            <button class="multi-select-btn" onclick="selectAllChartTaskStatuses()">Selecionar Todos</button>
            <button class="multi-select-btn" onclick="clearAllChartTaskStatuses()">Limpar</button>
        </div>
    </div>
    
    <div class="filter-group">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="applyChartFilters" style="width:100%;">
            <i class="fas fa-filter"></i> Aplicar Filtros
        </button>
    </div>
</div>

<div class="chart-period-info">
    <i class="fas fa-info-circle"></i>
    <span id="periodInfoText">Os gráficos mostram os dados filtrados. Use os filtros acima para ajustar.</span>
</div>

<!-- Cards de eficiência -->
<div class="charts-efficiency-section">
    <div class="charts-efficiency-cards">
        <div class="summary-card summary-card-efficiency">
            <h3 style="font-size:.85rem;color:#666">Eficiência de Projetos no Período</h3>
            <p id="periodProjectsEfficiency">0%</p>
        </div>
        <div class="summary-card summary-card-efficiency">
            <h3 style="font-size:.85rem;color:#666">Eficiência das Tarefas no Período</h3>
            <p id="periodTasksEfficiency">0%</p>
        </div>
    </div>
    
    <!-- Container dos gráficos -->
    <div class="charts-container">
        <!-- Gráfico Comparativo de Conclusão -->
        <div class="chart-card">
            <h3 class="chart-title">Comparativo de Conclusão vs Eficiência</h3>
            <div class="chart-period-info">
                <i class="fas fa-info-circle"></i>
                <span id="efficiencyChartInfo">Eficiência das tarefas no período: <span id="efficiencyValue">0%</span></span>
            </div>
            <canvas id="efficiencyChart"></canvas>
        </div>
        
        <!-- Gráfico de Status dos Projetos -->
        <div class="chart-card">
            <h3 class="chart-title">Status dos Projetos <small>(Clique nas fatias para ver detalhes)</small></h3>
            <div class="chart-period-info">
                <i class="fas fa-info-circle"></i>
                <span id="projectStatusChartInfo">Projetos concluídos no período: <span id="completedProjectsValue">0%</span></span>
            </div>
            <canvas id="projectStatusChart"></canvas>
        </div>
        
        <!-- Gráfico de Eficiência por Líder -->
        <div class="chart-card">
            <h3 class="chart-title">Eficiência por Líder (Concluído / Planejado) <small>(Clique nas barras para ver detalhes)</small></h3>
            <canvas id="leaderChart"></canvas>
        </div>
        
        <!-- Gráfico de Eficiência por Segmento -->
        <div class="chart-card">
            <h3 class="chart-title">Eficiência por Segmento (Concluído / Planejado) <small>(Clique nas barras para ver detalhes)</small></h3>
            <canvas id="segmentChart"></canvas>
        </div>
    </div>
</div>
</div>

<div class="table-container">
<table>
<thead>
<tr>
<th>ID</th><th>Cliente</th><th>Projeto</th><th>Segmento</th><th>Líder</th><th>Código</th><th>Modelo</th><th>Processo</th><th>Fase</th><th>Status</th><th>Observações</th>
<!-- KOM -->
<th class="column-group" style="color:black">KOM Status</th><th>KOM Planejado</th><th>KOM Início</th><th>KOM Executado</th>
<!-- FERRAMENTAL -->
<th class="column-group" style="color:black">Ferramental Status</th><th>Ferramental Planejado</th><th>Ferramental Início</th><th>Ferramental Executado</th>
<!-- Recursos do Ferramental -->
<th>Fêmea</th><th>Gab. Fanavid</th><th>Gab. Usinado</th><th>Matriz</th><th>Macho</th><th>Template</th><th>Chapelona</th><th>Plotter</th><th>Tela</th>
<!-- CAD+BOM+FT -->
<th class="column-group" style="color:black">CAD\+BOM\+FT Status</th><th>CAD+BOM+FT Planejado</th><th>CAD+BOM+FT Início</th><th>CAD+BOM+FT Executado</th>
<!-- TRY-OUT -->
<th class="column-group" style="color:black">Try-out Status</th>
<th>Quant. Entrada</th>
<th>Quant. Saída</th>
<th>Try-out Número</th><th>Try-out Planejado</th><th>Try-out Início</th><th>Try-out Executado</th>
<!-- Recursos do Try-out -->
<th>Corte</th><th>Lapidação</th><th>Furação/Rec</th><th>Montagem</th><th>Serigrafia</th><th>Queima</th><th>Fornos</th>
<!-- ENTREGA -->
<th class="column-group" style="color:black">Entrega Status</th><th>Entrega Número</th><th>Entrega Planejado</th><th>Entrega Início</th><th>Entrega Executado</th>
<!-- PSW -->
<th class="column-group" style="color:black">PSW Status</th><th>PSW Planejado</th><th>PSW Início</th><th>PSW Executado</th>
<!-- HANDOVER -->
<th class="column-group" style="color:black">Handover Status</th><th>Handover Planejado</th><th>Handover Início</th><th>Handover Executado</th>
<th class="column-group" style="color:black">Ações</th>
</tr>
</thead>
<tbody id="projectsTableBody">
<!-- preenchido via JS -->
</tbody>
</table>
</div>
</div>
<!-- History Modal - MODIFICADO: REMOVIDO O BOTÃO "ADICIONAR HISTÓRICO" -->
<div class="modal" id="historyModal">
    <div class="modal-content">
        <span class="close" data-close="historyModal">×</span>
        <h3 id="historyModalTitle">Histórico</h3>
        <div id="historyContent"></div>
        <div id="historyFormContainer" style="display:none;">
            <h4>Adicionar/Editar Histórico</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>Data do Histórico</label>
                    <input type="date" id="historyDate">
                </div>
                <div class="form-group">
                    <label>Motivo</label>
                    <textarea id="historyReason" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Data Antiga</label>
                    <input type="date" id="historyOldDate">
                </div>
                <div class="form-group">
                    <label>Data Nova</label>
                    <input type="date" id="historyNewDate">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn btn-danger" id="cancelHistoryBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveHistoryBtn">Salvar</button>
            </div>
        </div>
    </div>
</div>
<!-- Reschedule Modal -->
<div class="modal" id="rescheduleModal"><div class="modal-content"><span class="close" data-close="rescheduleModal">×</span><h3>Replanejar</h3>
<p id="rescheduleTaskInfo">Tarefa:</p>
<div class="form-group">
<label>Data Planejada Atual</label>
<input id="currentDate" readonly="" style="background-color: #f0f0f0;" type="text"/>
</div>
<div class="form-group">
<label>Nova Data Planejada</label>
<input id="newDate" type="date"/>
</div>
<div class="form-group"><label>Motivo</label><textarea id="rescheduleReason"></textarea></div>
<div class="form-buttons"><button class="btn btn-danger" id="cancelRescheduleBtn">Cancelar</button><button class="btn btn-primary" id="saveRescheduleBtn">Salvar</button></div>
</div></div>
<!-- File modal (export) -->
<div class="modal" id="fileModal"><div class="modal-content"><span class="close" data-close="fileModal">×</span><h3 id="fileModalTitle">Exportar</h3><div id="fileModalContent"></div></div></div>
<!-- Excel import modal -->
<div class="modal" id="excelImportModal"><div class="modal-content"><span class="close" data-close="excelImportModal">×</span><h3>Importar Excel</h3>
<div class="form-group"><label>Selecione o arquivo</label><input accept=".xlsx,.xls" id="excelFile" type="file"/></div>
<div class="form-group"><label><input id="importOverwrite" type="checkbox"/> Sobrescrever dados</label></div>
<div class="form-buttons"><button class="btn btn-danger" id="cancelImportBtn">Cancelar</button><button class="btn btn-primary" id="confirmImportBtn">Importar</button></div>
</div></div>
<!-- Shared File Configuration Modal -->
<div class="modal" id="sharedFileModal">
<div class="modal-content">
<span class="close" data-close="sharedFileModal">×</span>
<h3>Configuração de Arquivo Compartilhado</h3>
<div class="form-group">
<label>Caminho do Arquivo Compartilhado</label>
<input id="sharedFilePathInput" placeholder="ex: \\servidor\pasta\projetos.json" type="text"/>
<small>Informe o caminho de rede completo para o arquivo JSON compartilhado</small>
</div>
<div class="form-group">
<label>Intervalo de Sincronização (segundos)</label>
<input id="syncIntervalInput" min="5" type="number" value="30"/>
</div>
<div class="form-buttons">
<button class="btn btn-danger" id="cancelSharedFileBtn">Cancelar</button>
<button class="btn btn-primary" id="saveSharedFileBtn">Salvar</button>
</div>
</div>
</div>
<!-- Modal para mostrar projetos por status -->
<div class="modal" id="projectStatusModal">
<div class="modal-content">
<span class="close" data-close="projectStatusModal">×</span>
<h3>Projetos com status: <span id="modalStatusTitle"></span></h3>
<div id="projectStatusModalList"></div>
</div>
</div>
<!-- NOVO MODAL: Para listar projetos por qualquer critério - MELHORADO -->
<div class="modal" id="projectListModal">
<div class="modal-content">
<span class="close" data-close="projectListModal">×</span>
<h3 id="projectListModalTitle">Projetos</h3>
<div id="projectListModalContent"></div>
</div>
</div>

<script>
        // ==============================================
        // VARIÁVEIS GLOBAIS
        // ==============================================
        let projects = [];
        let leaders = [
            {id:1,name:"Henrique B.",email:"henrique@empresa.com",department:"Engenharia"},
            {id:2,name:"Carlos S.",email:"carlos@empresa.com",department:"Projetos"},
            {id:3,name:"Ana P.",email:"ana@empresa.com",department:"Qualidade"}
        ];
        let nextProjectId = 1;
        let nextLeaderId = 4;
        let currentEditingProjectId = null;
        let currentRescheduleInfo = null;

        // Variáveis para controle de arquivo compartilhado
        let sharedFilePath = localStorage.getItem('sharedFilePath') || '';
        let syncInterval = null;
        let syncIntervalTime = parseInt(localStorage.getItem('syncInterval')) || 30000;
        let lastSyncHash = '';
        let isSyncing = false;
        let syncStatus = 'offline';

        // Instâncias dos gráficos
        let efficiencyChart = null;
        let projectStatusChart = null;
        let leaderChart = null;
        let segmentChart = null;

        // Variáveis para controle de histórico editável
        let currentHistoryInfo = {
            projectId: null,
            taskKey: null,
            editingIndex: null
        };

        // ==============================================
        // CORREÇÃO DAS FUNÇÕES DE DATA
        // ==============================================
        
        // CORREÇÃO: Função para converter data para formato ISO sem problemas de fuso horário
        function toISODateString(date) {
            if (!date) return '';
            
            // Se já for uma string no formato YYYY-MM-DD, retornar diretamente
            if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                return date;
            }
            
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            
            // Usar UTC para evitar problemas de fuso horário
            const year = d.getUTCFullYear();
            const month = String(d.getUTCMonth() + 1).padStart(2, '0');
            const day = String(d.getUTCDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // CORREÇÃO: Função para criar data sem problemas de fuso horário
        function toDateOnly(d) {
            if (!d) return null;
            
            // Se for string no formato YYYY-MM-DD, converter diretamente
            if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) {
                const parts = d.split('-');
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            
            const dt = new Date(d);
            return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
        }

        // CORREÇÃO: Data atual sem problemas de fuso horário
        function today() { 
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }

        // CORREÇÃO: Função para formatar data no formato brasileiro
        function formatDateBR(d) {
            if (!d) return '-';
            const dt = toDateOnly(d);
            if (!dt || isNaN(dt.getTime())) return '-';
            return dt.toLocaleDateString('pt-BR');
        }

        // CORREÇÃO: Função para comparar datas
        function compareDates(dateA, dateB) {
            const a = toDateOnly(dateA);
            const b = toDateOnly(dateB);
            if (!a || !b) return 0;
            return a.getTime() - b.getTime();
        }

        function getMonthName(monthIndex) {
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[monthIndex];
        }

        // ==============================================
        // NOVAS FUNÇÕES PARA SELEÇÃO MÚLTIPLA DE STATUS
        // ==============================================
        
        function selectAllStatuses() {
            const select = document.getElementById('statusFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
            updateProjectsTable();
            updateSummary();
        }
        
        function clearAllStatuses() {
            const select = document.getElementById('statusFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            updateProjectsTable();
            updateSummary();
        }
        
        function selectAllTaskStatuses() {
            const select = document.getElementById('taskStatusFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }
        
        function clearAllTaskStatuses() {
            const select = document.getElementById('taskStatusFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
        }
        
        function selectAllChartTaskStatuses() {
            const select = document.getElementById('chartTaskStatus');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }
        
        function clearAllChartTaskStatuses() {
            const select = document.getElementById('chartTaskStatus');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
        }

        // ==============================================
        // FUNÇÃO PARA LIMPAR TODOS OS FILTROS
        // ==============================================
        function clearAllFilters() {
            // Limpar filtros principais
            document.getElementById('idFilter').value = '';
            document.getElementById('projectFilter').value = '';
            document.getElementById('segmentoFilter').value = 'todos';
            document.getElementById('leaderFilter').value = 'todos';
            document.getElementById('search').value = '';
            clearAllStatuses();
            
            // Limpar filtros de tarefa
            document.getElementById('dateFilterType').value = 'todos';
            document.getElementById('taskSegmentoFilter').value = 'todos';
            document.getElementById('taskLeaderFilter').value = 'todos';
            document.getElementById('dateFilterFrom').value = '';
            document.getElementById('dateFilterTo').value = '';
            clearAllTaskStatuses();
            
            // Atualizar tabela
            updateProjectsTable();
            updateSummary();
        }

        // ==============================================
        // NOVA FUNÇÃO PARA CONTAR PROJETOS FILTRADOS POR TAREFA
        // ==============================================
        function countFilteredProjectsByTask() {
            const taskType = document.getElementById('dateFilterType').value;
            const taskSegmento = document.getElementById('taskSegmentoFilter').value;
            const taskLeader = document.getElementById('taskLeaderFilter').value;
            const dateFrom = document.getElementById('dateFilterFrom').value;
            const dateTo = document.getElementById('dateFilterTo').value;
            
            // Obter status de tarefa selecionados (múltiplos)
            const taskStatusFilterElements = document.getElementById('taskStatusFilter').selectedOptions;
            const taskStatusFilter = Array.from(taskStatusFilterElements).map(option => option.value);
            
            // Contadores
            let totalByTaskType = 0;
            let totalByStatus = 0;
            let totalBySegment = 0;
            let totalByLeader = 0;
            
            // Apenas contar se algum filtro está ativo
            const hasAnyFilter = taskType !== 'todos' || 
                                taskSegmento !== 'todos' || 
                                taskLeader !== 'todos' || 
                                dateFrom || 
                                dateTo || 
                                taskStatusFilter.length > 0;
            
            if (!hasAnyFilter) {
                // Esconder o contador se nenhum filtro estiver ativo
                document.getElementById('taskFilterCountContainer').style.display = 'none';
                return;
            }
            
            // Mostrar o contador
            document.getElementById('taskFilterCountContainer').style.display = 'flex';
            
            // Contar projetos para cada critério
            projects.forEach(project => {
                let matchesTaskType = false;
                let matchesStatus = false;
                let matchesSegment = false;
                let matchesLeader = false;
                let matchesAll = true;
                
                // Verificar tipo de tarefa
                if (taskType !== 'todos') {
                    const task = project.tasks?.[taskType];
                    if (task) {
                        matchesTaskType = true;
                        
                        // Verificar status da tarefa específica
                        if (taskStatusFilter.length > 0) {
                            const taskStatus = calculateTaskStatus(task, project.status);
                            if (taskStatusFilter.includes(taskStatus)) {
                                matchesStatus = true;
                            } else {
                                matchesAll = false;
                            }
                        } else {
                            matchesStatus = true;
                        }
                        
                        // Verificar segmento
                        if (taskSegmento !== 'todos') {
                            if (project.segmento === taskSegmento) {
                                matchesSegment = true;
                            } else {
                                matchesAll = false;
                            }
                        } else {
                            matchesSegment = true;
                        }
                        
                        // Verificar líder
                        if (taskLeader !== 'todos') {
                            if (project.leaderId == taskLeader) {
                                matchesLeader = true;
                            } else {
                                matchesAll = false;
                            }
                        } else {
                            matchesLeader = true;
                        }
                        
                        // Verificar período da tarefa
                        if (dateFrom || dateTo) {
                            let dateInRange = false;
                            const fromDateObj = dateFrom ? toDateOnly(dateFrom) : null;
                            const toDateObj = dateTo ? toDateOnly(dateTo) : null;
                            
                            if (task.planned) {
                                const plannedDate = toDateOnly(task.planned);
                                if ((!fromDateObj || compareDates(plannedDate, fromDateObj) >= 0) && 
                                    (!toDateObj || compareDates(plannedDate, toDateObj) <= 0)) {
                                    dateInRange = true;
                                }
                            }
                            
                            if (!dateInRange) {
                                matchesAll = false;
                                matchesTaskType = false;
                                matchesStatus = false;
                                matchesSegment = false;
                                matchesLeader = false;
                            }
                        }
                    } else {
                        matchesAll = false;
                    }
                } else {
                    // Se tipo de tarefa é "todos", considerar todas as tarefas
                    const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
                    let hasAnyTask = false;
                    
                    taskKeys.forEach(key => {
                        const task = project.tasks?.[key];
                        if (task) {
                            hasAnyTask = true;
                            matchesTaskType = true;
                            
                            // Verificar status
                            if (taskStatusFilter.length > 0) {
                                const taskStatus = calculateTaskStatus(task, project.status);
                                if (taskStatusFilter.includes(taskStatus)) {
                                    matchesStatus = true;
                                }
                            } else {
                                matchesStatus = true;
                            }
                        }
                    });
                    
                    // Verificar segmento
                    if (taskSegmento !== 'todos') {
                        if (project.segmento === taskSegmento) {
                            matchesSegment = true;
                        } else {
                            matchesAll = false;
                        }
                    } else {
                        matchesSegment = true;
                    }
                    
                    // Verificar líder
                    if (taskLeader !== 'todos') {
                        if (project.leaderId == taskLeader) {
                            matchesLeader = true;
                        } else {
                            matchesAll = false;
                        }
                    } else {
                        matchesLeader = true;
                    }
                    
                    if (!hasAnyTask) {
                        matchesAll = false;
                    }
                }
                
                // Incrementar contadores
                if (matchesTaskType) totalByTaskType++;
                if (matchesStatus) totalByStatus++;
                if (matchesSegment) totalBySegment++;
                if (matchesLeader) totalByLeader++;
            });
            
            // Atualizar os valores na interface
            document.getElementById('taskFilterCountTotal').textContent = totalByTaskType;
            document.getElementById('taskFilterCountByStatus').textContent = totalByStatus;
            document.getElementById('taskFilterCountBySegment').textContent = totalBySegment;
            document.getElementById('taskFilterCountByLeader').textContent = totalByLeader;
        }

        // ==============================================
        // FUNÇÕES DE LOCALSTORAGE
        // ==============================================
        function saveToLocalStorage(){
            localStorage.setItem('projectManagementData', JSON.stringify({projects,leaders}));
        }
        
        function loadFromLocalStorage(){
            const s = localStorage.getItem('projectManagementData');
            if(!s) return;
            try{
                const data = JSON.parse(s);
                projects = data.projects || [];
                leaders = data.leaders || leaders;
                if(projects.length) nextProjectId = Math.max(...projects.map(p=>p.id))+1;
                if(leaders.length) nextLeaderId = Math.max(...leaders.map(l=>l.id))+1;
            }catch(e){ console.warn('load error',e); }
        }

        // ==============================================
        // INTEGRAÇÃO COM O BACKEND (PHP / MySQL)
        // ==============================================
        async function atualizarDadosDoBanco(){
            try{
                updateSyncIndicator(true);
                const res = await fetch('buscar.php', {cache: 'no-store'});
                if(!res.ok) throw new Error('Resposta não OK');
                const data = await res.json();
                if(data && data.status && (data.status === 'sucesso' || data.status === 'ok')){
                    projects = data.projetos || data.projetos || projects;
                    leaders = data.lideres || data.lideres || leaders;
                    if(projects.length) nextProjectId = Math.max(...projects.map(p=>p.id))+1;
                    if(leaders.length) nextLeaderId = Math.max(...leaders.map(l=>l.id))+1;
                    saveToLocalStorage();
                    updateLeaderFilter();
                    updateTaskLeaderFilter();
                    updateProjectLeaderSelect();
                    updateLeadersList();
                    updateProjectsTable();
                    updateSummary();
                    syncStatus = 'online';
                } else {
                    console.warn('buscar.php retornou formato inesperado', data);
                    syncStatus = 'offline';
                }
            }catch(err){
                console.warn('Erro ao atualizar do banco:', err);
                syncStatus = 'offline';
            }finally{
                updateSyncIndicator(false);
            }
        }

        function pushProjectToServer(project){
            // enviar em background, não bloquear a UI
            try{
                fetch('salvar_projeto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project })
                }).then(r=>r.json()).then(resp=>{
                    if(resp && resp.status && (resp.status === 'sucesso' || resp.status === 'ok')){
                        console.log('Projeto salvo no servidor');
                    }else{
                        console.warn('Resposta salvar_projeto.php inesperada', resp);
                    }
                }).catch(e=>console.warn('Erro ao salvar projeto no servidor', e));
            }catch(e){ console.warn(e); }
        }

        function pushLeaderToServer(leader){
            try{
                fetch('salvar_lider.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leader })
                }).then(r=>r.json()).then(resp=>{
                    if(resp && resp.status && (resp.status === 'sucesso' || resp.status === 'ok')){
                        console.log('Líder salvo no servidor');
                    }else{
                        console.warn('Resposta salvar_lider.php inesperada', resp);
                    }
                }).catch(e=>console.warn('Erro ao salvar líder no servidor', e));
            }catch(e){ console.warn(e); }
        }

        function deleteProjectOnServer(id){
            try{
                fetch('delete_project.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                }).then(r=>r.json()).then(resp=>{
                    if(resp && resp.status && (resp.status === 'sucesso' || resp.status === 'ok')){
                        console.log('Projeto removido no servidor');
                    }else{
                        console.warn('Resposta delete_project.php inesperada', resp);
                    }
                }).catch(e=>console.warn('Erro ao deletar projeto no servidor', e));
            }catch(e){ console.warn(e); }
        }

        // ==============================================
        // FUNÇÕES DE FILTRO E ATUALIZAÇÃO - MODIFICADAS PARA SELEÇÃO MÚLTIPLA
        // ==============================================
        function getFilteredProjects(){
            const idFilter = (document.getElementById('idFilter').value||'').toLowerCase();
            const projectFilter = (document.getElementById('projectFilter').value||'').toLowerCase();
            const segmentoFilter = document.getElementById('segmentoFilter').value;
            const leaderFilter = document.getElementById('leaderFilter').value;
            const search = (document.getElementById('search').value||'').toLowerCase();
            
            // Obter status selecionados (múltiplos)
            const statusFilterElements = document.getElementById('statusFilter').selectedOptions;
            const statusFilter = Array.from(statusFilterElements).map(option => option.value);
            
            // NOVO: Separar filtros de projeto dos filtros de tarefa específica
            const dateType = document.getElementById('dateFilterType').value;
            const dateFrom = document.getElementById('dateFilterFrom').value;
            const dateTo = document.getElementById('dateFilterTo').value;
            
            // Obter status de tarefa selecionados (múltiplos)
            const taskStatusFilterElements = document.getElementById('taskStatusFilter').selectedOptions;
            const taskStatusFilter = Array.from(taskStatusFilterElements).map(option => option.value);
            
            const taskSegmentoFilter = document.getElementById('taskSegmentoFilter').value;
            const taskLeaderFilter = document.getElementById('taskLeaderFilter').value;

            // Primeiro filtrar por critérios gerais do projeto
            let filteredProjects = projects.filter(p=>{
                // Filtros básicos do projeto
                if(idFilter && !p.id.toString().includes(idFilter)) return false;
                if(projectFilter && !(p.projectName||'').toLowerCase().includes(projectFilter)) return false;
                if(segmentoFilter !== 'todos' && p.segmento !== segmentoFilter) return false;
                if(leaderFilter !== 'todos' && p.leaderId != leaderFilter) return false;
                
                // Filtro de status múltiplo
                if(statusFilter.length > 0 && !statusFilter.includes(p.status)) return false;
                
                if(search){
                    const hay = `${p.cliente} ${p.projectName} ${p.codigo} ${p.modelo} ${p.observacoes}`.toLowerCase();
                    if(!hay.includes(search)) return false;
                }
                return true;
            });

            // DEPOIS aplicar filtros específicos de tarefa APENAS se especificado
            if(dateType && dateType!=='todos' && (dateFrom||dateTo||taskStatusFilter.length>0||taskSegmentoFilter!=='todos'||taskLeaderFilter!=='todos')){
                filteredProjects = filteredProjects.filter(p=>{
                    const task = p.tasks?.[dateType];
                    if(!task) return false;
                    
                    // Verificar status da tarefa específica (múltiplos)
                    if(taskStatusFilter.length > 0) {
                        const taskStatus = calculateTaskStatus(task, p.status);
                        if(!taskStatusFilter.includes(taskStatus)) return false;
                    }
                    
                    // Verificar segmento específico para tarefa
                    if(taskSegmentoFilter !== 'todos' && p.segmento !== taskSegmentoFilter) return false;
                    
                    // Verificar líder específico para tarefa
                    if(taskLeaderFilter !== 'todos' && p.leaderId != taskLeaderFilter) return false;
                    
                    // CORREÇÃO: Considerar APENAS a data planejada para o filtro
                    let dateInRange = false;
                    const fromDateObj = dateFrom ? toDateOnly(dateFrom) : null;
                    const toDateObj = dateTo ? toDateOnly(dateTo) : null;
                    
                    // Apenas data planejada da tarefa específica
                    if(task.planned) {
                        const plannedDate = toDateOnly(task.planned);
                        if((!fromDateObj || compareDates(plannedDate, fromDateObj) >= 0) && 
                           (!toDateObj || compareDates(plannedDate, toDateObj) <= 0)) {
                            dateInRange = true;
                        }
                    }
                    
                    // Se há filtro de data e não encontrou a data planejada no intervalo, filtrar o projeto
                    if((dateFrom || dateTo) && !dateInRange) return false;
                    
                    return true;
                });
            }
            
            return filteredProjects;
        }

        function updateProjectsTable(){
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = '';
            const list = getFilteredProjects();
            if(!list.length){ tbody.innerHTML = '<tr><td colspan="60" style="text-align:center;padding:18px">Nenhum projeto encontrado.</td></tr>'; return; }

            list.forEach(p=>{
                const komStatus = calculateTaskStatus(p.tasks?.kom, p.status);
                const ferramentalStatus = calculateTaskStatus(p.tasks?.ferramental, p.status);
                const cadBomFtStatus = calculateTaskStatus(p.tasks?.cadBomFt, p.status);
                const tryoutStatus = calculateTaskStatus(p.tasks?.tryout, p.status);
                const entregaStatus = calculateTaskStatus(p.tasks?.entrega, p.status);
                const pswStatus = calculateTaskStatus(p.tasks?.psw, p.status);
                const handoverStatus = calculateTaskStatus(p.tasks?.handover, p.status);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.cliente||'-'}</td>
                    <td>${p.projectName||'-'}</td>
                    <td>${p.segmento||'-'}</td>
                    <td>${p.projectLeader||'-'}</td>
                    <td>${p.codigo||'-'}</td>
                    <td>${p.modelo||'-'}</td>
                    <td>${p.processo||'-'}</td>
                    <td>${p.fase||'-'}</td>
                    <td><span class="status status-${p.status.toLowerCase().replace(/\s/g,'-')}">${p.status}</span></td>
                    <td>${p.observacoes||'-'}</td>

                    <!-- KOM -->
                    <td class="column-group">${renderStatusCell(komStatus,p.tasks?.kom?.history,'kom',p.id)}</td>
                    <td>${formatDateBR(p.tasks?.kom?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.kom?.start)}</td>
                    <td>${formatDateBR(p.tasks?.kom?.executed)}</td>

                    <!-- FERRAMENTAL -->
                    <td class="column-group">${renderStatusCell(ferramentalStatus,p.tasks?.ferramental?.history,'ferramental',p.id)}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.start)}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.executed)}</td>
                    
                    <!-- Recursos do Ferramental -->
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.femea) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.gabaritoFanavid) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.gabaritoUsinado) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.matriz) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.macho) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.template) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.chapelona) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.plotter) || '-'}</td>
                    <td>${formatDateBR(p.tasks?.ferramental?.resources?.tela) || '-'}</td>

                    <!-- CAD+BOM+FT -->
                    <td class="column-group">${renderStatusCell(cadBomFtStatus,p.tasks?.cadBomFt?.history,'cadBomFt',p.id)}</td>
                    <td>${formatDateBR(p.tasks?.cadBomFt?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.cadBomFt?.start)}</td>
                    <td>${formatDateBR(p.tasks?.cadBomFt?.executed)}</td>

                    <!-- TRY-OUT -->
                    <td class="column-group">${renderStatusCell(tryoutStatus,p.tasks?.tryout?.history,'tryout',p.id)}</td>
                    <td>${p.tasks?.tryout?.quantidadeEntrada || '-'}</td>
                    <td>${p.tasks?.tryout?.quantidadeSaida || '-'}</td>
                    <td>${p.tasks?.tryout?.number||'-'}</td>
                    <td>${formatDateBR(p.tasks?.tryout?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.tryout?.start)}</td>
                    <td>${formatDateBR(p.tasks?.tryout?.executed)}</td>
                    
                    <!-- Recursos do Try-out -->
                    <td>${p.tasks?.tryout?.resources?.corte || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.lapidacao || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.furacao || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.montagem || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.serigrafia || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.queima || '-'}</td>
                    <td>${p.tasks?.tryout?.resources?.fornos || '-'}</td>

                    <!-- ENTREGA -->
                    <td class="column-group">${renderStatusCell(entregaStatus,p.tasks?.entrega?.history,'entrega',p.id)}</td>
                    <td>${p.tasks?.entrega?.number||'-'}</td>
                    <td>${formatDateBR(p.tasks?.entrega?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.entrega?.start)}</td>
                    <td>${formatDateBR(p.tasks?.entrega?.executed)}</td>

                    <!-- PSW -->
                    <td class="column-group">${renderStatusCell(pswStatus,p.tasks?.psw?.history,'psw',p.id)}</td>
                    <td>${formatDateBR(p.tasks?.psw?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.psw?.start)}</td>
                    <td>${formatDateBR(p.tasks?.psw?.executed)}</td>

                    <!-- HANDOVER -->
                    <td class="column-group">${renderStatusCell(handoverStatus,p.tasks?.handover?.history,'handover',p.id)}</td>
                    <td>${formatDateBR(p.tasks?.handover?.planned)}</td>
                    <td>${formatDateBR(p.tasks?.handover?.start)}</td>
                    <td>${formatDateBR(p.tasks?.handover?.executed)}</td>

                    <!-- AÇÕES -->
                    <td class="column-group">
                        <button class="btn btn-primary btn-sm" onclick="editProject(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProject(${p.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Atualizar contador de projetos no status selecionado
            updateTaskStatusCount();
            
            // NOVO: Atualizar contador de projetos filtrados por tarefa
            countFilteredProjectsByTask();
        }

        function renderStatusCell(status,history,taskKey,projectId){
            const historyCount = history ? history.length : 0;
            return `
                <span class="status status-${status.toLowerCase().replace(/\s/g,'-')}">${status}</span>
                <button class="history-badge" onclick="showHistoryModal(${projectId}, '${taskKey}')">${historyCount}</button>
                <button class="reschedule-btn" onclick="openRescheduleModal(${projectId}, '${taskKey}')"><i class="fas fa-calendar-alt"></i></button>
            `;
        }

        // Atualizar contador de projetos no status selecionado - MODIFICADO
        function updateTaskStatusCount() {
            const taskStatusFilterElements = document.getElementById('taskStatusFilter').selectedOptions;
            const taskStatusFilter = Array.from(taskStatusFilterElements).map(option => option.value);
            
            const dateType = document.getElementById('dateFilterType').value;
            const dateFrom = document.getElementById('dateFilterFrom').value;
            const dateTo = document.getElementById('dateFilterTo').value;
            const taskSegmentoFilter = document.getElementById('taskSegmentoFilter').value;
            const taskLeaderFilter = document.getElementById('taskLeaderFilter').value;
            
            if (taskStatusFilter.length === 0 && dateType === 'todos' && !dateFrom && !dateTo && taskSegmentoFilter === 'todos' && taskLeaderFilter === 'todos') {
                document.getElementById('taskStatusCount').style.display = 'none';
                return;
            }
            
            let count = 0;
            
            if (dateType && dateType !== 'todos') {
                // Contar apenas projetos que têm a tarefa específica nos critérios
                projects.forEach(p => {
                    const task = p.tasks?.[dateType];
                    if (!task) return;
                    
                    // Verificar status da tarefa específica (múltiplos)
                    if (taskStatusFilter.length > 0) {
                        const taskStatus = calculateTaskStatus(task, p.status);
                        if (!taskStatusFilter.includes(taskStatus)) return;
                    }
                    
                    // Verificar segmento específico
                    if (taskSegmentoFilter !== 'todos' && p.segmento !== taskSegmentoFilter) return;
                    
                    // Verificar líder específico
                    if (taskLeaderFilter !== 'todos' && p.leaderId != taskLeaderFilter) return;
                    
                    // Verificar datas apenas para a tarefa específica
                    let dateInRange = false;
                    const fromDateObj = dateFrom ? toDateOnly(dateFrom) : null;
                    const toDateObj = dateTo ? toDateOnly(dateTo) : null;
                    
                    if(task.planned) {
                        const plannedDate = toDateOnly(task.planned);
                        if((!fromDateObj || compareDates(plannedDate, fromDateObj) >= 0) && 
                           (!toDateObj || compareDates(plannedDate, toDateObj) <= 0)) {
                            dateInRange = true;
                        }
                    }

                    if((dateFrom || dateTo) && !dateInRange) return;
                    
                    count++;
                });
            }
            
            document.getElementById('taskStatusCountValue').textContent = count;
            document.getElementById('taskStatusCount').style.display = 'inline-block';
        }

        // Atualizar resumo usando apenas os projetos filtrados - MODIFICADO
        function updateSummary(){
            const list = getFilteredProjects();
            document.getElementById('totalProjects').innerText = list.length;
            document.getElementById('onTimeProjects').innerText = list.filter(p=>p.status==="No Prazo").length;
            document.getElementById('delayedProjects').innerText = list.filter(p=>p.status==="Atrasado").length;
            document.getElementById('completedProjects').innerText = list.filter(p=>p.status==="Concluído").length;
            document.getElementById('onHoldProjects').innerText = list.filter(p=>p.status==="Em Espera").length;
            document.getElementById('cancelledProjects').innerText = list.filter(p=>p.status==="Cancelado").length;
            document.getElementById('totalLeaders').innerText = leaders.length;
            document.getElementById('syncStatus').innerText = syncStatus;
            
            // Atualizar eficiências
            const tasksEfficiency = calculateTasksEfficiency(list);
            const projectsEfficiency = calculateProjectsEfficiency(list);
            
            document.getElementById('tasksEfficiency').innerText = `${tasksEfficiency.toFixed(1)}%`;
            document.getElementById('projectsEfficiency').innerText = `${projectsEfficiency.toFixed(1)}%`;
        }

        // Atualizar filtro de líderes
        function updateLeaderFilter(){
            const sel = document.getElementById('leaderFilter');
            const oldVal = sel.value;
            sel.innerHTML = '<option value="todos">Todos os Líderes</option>';
            leaders.forEach(l=>sel.innerHTML += `<option value="${l.id}">${l.name}</option>`);
            if(oldVal) sel.value = oldVal;
        }

        // Atualizar filtro de líderes para tarefas
        function updateTaskLeaderFilter(){
            const sel = document.getElementById('taskLeaderFilter');
            const oldVal = sel.value;
            sel.innerHTML = '<option value="todos">Todos os Líderes</option>';
            leaders.forEach(l=>sel.innerHTML += `<option value="${l.id}">${l.name}</option>`);
            if(oldVal) sel.value = oldVal;
        }

        function updateProjectLeaderSelect(){
            const sel = document.getElementById('projectLeader');
            const oldVal = sel.value;
            sel.innerHTML = '<option value="">Selecione</option>';
            leaders.forEach(l=>sel.innerHTML += `<option value="${l.id}">${l.name}</option>`);
            if(oldVal) sel.value = oldVal;
        }

        function updateLeadersList(){
            const cont = document.getElementById('leadersListContainer');
            cont.innerHTML = '';
            if(!leaders.length){ cont.innerHTML = '<p>Nenhum líder cadastrado.</p>'; return; }
            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            leaders.forEach(l=>{
                const li = document.createElement('li');
                li.style.padding = '12px';
                li.style.borderBottom = '1px solid #eee';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.innerHTML = `
                    <div>
                        <strong>${l.name}</strong> (${l.department})<br>
                        <small>${l.email}</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteLeader(${l.id})"><i class="fas fa-trash"></i></button>
                `;
                ul.appendChild(li);
            });
            cont.appendChild(ul);
        }

        // Cálculo de status - MODIFICADA PARA CONSIDERAR STATUS DO PROJETO
        function calculateTaskStatus(task, projectStatus = null){
            // Se o projeto estiver cancelado ou em espera, a tarefa também está
            if (projectStatus === 'Cancelado' || projectStatus === 'Em Espera') {
                return projectStatus;
            }
            
            // Se o projeto está no modo automático, calcula com base nas datas
            if(!task) return 'Pendente';
            
            // Se tem data de conclusão, está concluído
            if(task.executed) return 'Concluído';
            
            const todayDate = today();
            
            // Se tem data de início mas não tem conclusão
            if(task.start) {
                const startDate = toDateOnly(task.start);
                
                // If the start date is today or earlier
                if(startDate && startDate <= todayDate) {
                    // Verificar se tem data planejada
                    if(task.planned) {
                        const plannedDate = toDateOnly(task.planned);
                        // Se hoje é depois da data planejada, está atrasado
                        if(plannedDate && todayDate > plannedDate) {
                            return 'Atrasado';
                        }
                    }
                    return 'Em Andamento';
                }
                // Se a data de início é futura
                return 'Pendente';
            }
            
            // Se não tem data de início, verifica se a data planejada já passou
            if(task.planned) {
                const plannedDate = toDateOnly(task.planned);
                if(plannedDate && todayDate > plannedDate) {
                    return 'Atrasado';
                }
                // Se tem data planejada and ainda não chegou
                if(plannedDate && todayDate <= plannedDate) {
                    return 'No Prazo';
                }
            }
            
            // Caso padrão
            return 'Pendente';
        }

        function calculateProjectStatus(project){
            const tasks = project.tasks;
            if(!tasks) return 'Pendente';
            
            // Verificar se há status manual definido
            if (project.manualStatus === 'Cancelado' || project.manualStatus === 'Em Espera') {
                return project.manualStatus;
            }
            
            const taskKeys = ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'];
            let allCompleted = true;
            let anyInProgress = false;
            let anyDelayed = false;

            taskKeys.forEach(key=>{
                const status = calculateTaskStatus(tasks[key], project.status);
                if(status !== 'Concluído') allCompleted = false;
                if(status === 'Em Andamento') anyInProgress = true;
                if(status === 'Atrasado') anyDelayed = true;
            });

            if(allCompleted) return 'Concluído';
            if(anyDelayed) return 'Atrasado';
            if(anyInProgress) return 'Em Andamento';
            return 'No Prazo';
        }

        // ==============================================
        // FUNÇÕES DE FORMULÁRIO
        // ==============================================
        function showProjectForm(editId=null){
            document.getElementById('projectForm').style.display = 'block';
            document.getElementById('leadersForm').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            currentEditingProjectId = editId;
            document.getElementById('formTitle').textContent = editId ? 'Editar Projeto' : 'Novo Projeto';
            if(editId){
                const p = projects.find(pr=>pr.id===editId);
                if(p){
                    document.getElementById('cliente').value = p.cliente||'';
                    document.getElementById('projectName').value = p.projectName||'';
                    document.getElementById('segmento').value = p.segmento||'';
                    document.getElementById('projectLeader').value = p.leaderId||'';
                    document.getElementById('codigo').value = p.codigo||'';
                    document.getElementById('modelo').value = p.modelo||'';
                    document.getElementById('processo').value = p.processo||'';
                    document.getElementById('fase').value = p.fase||'';
                    document.getElementById('observacoes').value = p.observacoes||'';
                    
                    // Preencher o status do projeto
                    let projectStatusValue = 'automatico';
                    if (p.status === 'Em Espera') projectStatusValue = 'em espera';
                    else if (p.status === 'Cancelado') projectStatusValue = 'cancelado';
                    document.getElementById('projectStatusSelect').value = projectStatusValue;
                    
                    // Preencher as datas das tarefas
                    fillTaskDates('kom', p.tasks?.kom);
                    fillTaskDates('ferramental', p.tasks?.ferramental);
                    fillTaskDates('cadBomFt', p.tasks?.cadBomFt);
                    fillTaskDates('tryout', p.tasks?.tryout);
                    fillTaskDates('entrega', p.tasks?.entrega);
                    fillTaskDates('psw', p.tasks?.psw);
                    fillTaskDates('handover', p.tasks?.handover);
                    
                    // Preencher número do tryout e entrega
                    document.getElementById('tryoutNumber').value = p.tasks?.tryout?.number || '';
                    document.getElementById('entregaNumber').value = p.tasks?.entrega?.number || '';
                    
                    // Preencher quantidades de entrada e saída do tryout
                    document.getElementById('tryoutQuantidadeEntrada').value = p.tasks?.tryout?.quantidadeEntrada || '';
                    document.getElementById('tryoutQuantidadeSaida').value = p.tasks?.tryout?.quantidadeSaida || '';
                    
                    // Preencher recursos da tarefa Try-out
                    document.getElementById('tryoutCorte').value = p.tasks?.tryout?.resources?.corte || '';
                    document.getElementById('tryoutLapidacao').value = p.tasks?.tryout?.resources?.lapidacao || '';
                    document.getElementById('tryoutFuracao').value = p.tasks?.tryout?.resources?.furacao || '';
                    document.getElementById('tryoutMontagem').value = p.tasks?.tryout?.resources?.montagem || '';
                    document.getElementById('tryoutSerigrafia').value = p.tasks?.tryout?.resources?.serigrafia || '';
                    document.getElementById('tryoutQueima').value = p.tasks?.tryout?.resources?.queima || '';
                    document.getElementById('tryoutFornos').value = p.tasks?.tryout?.resources?.fornos || '';
                    
                    // Preencher recursos da tarefa Ferramental (agora são datas)
                    document.getElementById('ferramentalFemea').value = toISODateString(p.tasks?.ferramental?.resources?.femea) || '';
                    document.getElementById('ferramentalGabaritoFanavid').value = toISODateString(p.tasks?.ferramental?.resources?.gabaritoFanavid) || '';
                    document.getElementById('ferramentalGabaritoUsinado').value = toISODateString(p.tasks?.ferramental?.resources?.gabaritoUsinado) || '';
                    document.getElementById('ferramentalMatriz').value = toISODateString(p.tasks?.ferramental?.resources?.matriz) || '';
                    document.getElementById('ferramentalMacho').value = toISODateString(p.tasks?.ferramental?.resources?.macho) || '';
                    document.getElementById('ferramentalTemplate').value = toISODateString(p.tasks?.ferramental?.resources?.template) || '';
                    document.getElementById('ferramentalChapelona').value = toISODateString(p.tasks?.ferramental?.resources?.chapelona) || '';
                    document.getElementById('ferramentalPlotter').value = toISODateString(p.tasks?.ferramental?.resources?.plotter) || '';
                    document.getElementById('ferramentalTela').value = toISODateString(p.tasks?.ferramental?.resources?.tela) || '';
                    
                    // Atualizar status das tarefas
                    updateAllTaskStatusesDisplay(p.status);
                }
            }else{
                document.getElementById('projectForm').reset();
                // Limpar status das tarefas
                updateAllTaskStatusesDisplay('automatico');
            }
            
            // Scroll para o topo do formulário
            document.getElementById('projectForm').scrollTop = 0;
        }

        // NOVA FUNÇÃO: Atualizar todos os status das tarefas
        function updateAllTaskStatusesDisplay(projectStatus) {
            const taskKeys = ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'];
            taskKeys.forEach(taskKey => {
                const taskData = {
                    planned: document.getElementById(`${taskKey}Planned`).value,
                    start: document.getElementById(`${taskKey}Start`).value,
                    executed: document.getElementById(`${taskKey}Executed`).value
                };
                updateTaskStatusDisplay(taskKey, taskData, projectStatus);
            });
        }

        // MODIFICADA: Atualizar display do status da tarefa considerando status do projeto
        function updateTaskStatusDisplay(taskKey, taskData, projectStatus) {
            const statusCell = document.getElementById(`${taskKey}StatusCell`);
            let statusToUse = 'automatico';
            if (projectStatus === 'em espera') statusToUse = 'Em Espera';
            else if (projectStatus === 'cancelado') statusToUse = 'Cancelado';
            
            const status = calculateTaskStatus(taskData, statusToUse);
            statusCell.textContent = status;
            statusCell.className = `status status-${status.toLowerCase().replace(/\s/g, '-')}`;
        }

        function fillTaskDates(taskKey, taskData) {
            if (taskData) {
                // CORREÇÃO: Usar toISODateString para garantir formato correto
                document.getElementById(`${taskKey}Planned`).value = toISODateString(taskData.planned);
                document.getElementById(`${taskKey}Planned2`).value = toISODateString(taskData.planned);
                document.getElementById(`${taskKey}Start`).value = toISODateString(taskData.start);
                document.getElementById(`${taskKey}Executed`).value = toISODateString(taskData.executed);
                
                // Preencher número para tryout e entrega
                if (taskKey === 'tryout' || taskKey === 'entrega') {
                    document.getElementById(`${taskKey}Number`).value = taskData.number || '';
                }
                
                // Preencher quantidades para tryout
                if (taskKey === 'tryout') {
                    document.getElementById('tryoutQuantidadeEntrada').value = taskData.quantidadeEntrada || '';
                    document.getElementById('tryoutQuantidadeSaida').value = taskData.quantidadeSaida || '';
                }
            } else {
                document.getElementById(`${taskKey}Planned`).value = '';
                document.getElementById(`${taskKey}Planned2`).value = '';
                document.getElementById(`${taskKey}Start`).value = '';
                document.getElementById(`${taskKey}Executed`).value = '';
                
                // Limpar número para tryout e entrega
                if (taskKey === 'tryout' || taskKey === 'entrega') {
                    document.getElementById(`${taskKey}Number`).value = '';
                }
                
                // Limpar quantidades para tryout
                if (taskKey === 'tryout') {
                    document.getElementById('tryoutQuantidadeEntrada').value = '';
                    document.getElementById('tryoutQuantidadeSaida').value = '';
                }
            }
        }

        
        function saveProject(){
            const cliente = document.getElementById('cliente').value.trim();
            const projectName = document.getElementById('projectName').value.trim();
            const segmento = document.getElementById('segmento').value;
            const leaderId = document.getElementById('projectLeader').value;
            const codigo = document.getElementById('codigo').value.trim();
            const modelo = document.getElementById('modelo').value;
            const processo = document.getElementById('processo').value;
            const fase = document.getElementById('fase').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            if(!cliente || !projectName || !leaderId){
                alert('Preencha os campos obrigatórios: Cliente, Projeto e Líder.');
                return;
            }

            // Determinar status final respeitando o dropdown
            const statusSelectVal = document.getElementById('projectStatusSelect').value;
            let finalStatus = 'Pendente';
            let manualStatus = null;
            
            if (statusSelectVal === 'automatico') {
                manualStatus = null;
            } else if (statusSelectVal === 'em espera') {
                finalStatus = 'Em Espera';
                manualStatus = 'Em Espera';
            } else if (statusSelectVal === 'cancelado') {
                finalStatus = 'Cancelado';
                manualStatus = 'Cancelado';
            }

            // Obter dados das tarefas
            const tasks = {};
            ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'].forEach(taskKey => {
                // CORREÇÃO: Usar toISODateString para garantir formato correto
                const planned = toISODateString(document.getElementById(`${taskKey}Planned`).value);
                const start = toISODateString(document.getElementById(`${taskKey}Start`).value);
                const executed = toISODateString(document.getElementById(`${taskKey}Executed`).value);
                const number = (taskKey === 'tryout' || taskKey === 'entrega') ? 
                    (document.getElementById(`${taskKey}Number`) ? document.getElementById(`${taskKey}Number`).value : '') : undefined;
                
                // Obter quantidades para tryout
                const quantidadeEntrada = (taskKey === 'tryout') ? 
                    (document.getElementById('tryoutQuantidadeEntrada') ? parseInt(document.getElementById('tryoutQuantidadeEntrada').value) || 0 : 0) : undefined;
                const quantidadeSaida = (taskKey === 'tryout') ? 
                    (document.getElementById('tryoutQuantidadeSaida') ? parseInt(document.getElementById('tryoutQuantidadeSaida').value) || 0 : 0) : undefined;
                
                // Obter recursos para Try-out e Ferramental
                let resources = undefined;
                if (taskKey === 'tryout') {
                    resources = {
                        corte: (document.getElementById('tryoutCorte') ? document.getElementById('tryoutCorte').value : ''),
                        lapidacao: (document.getElementById('tryoutLapidacao') ? document.getElementById('tryoutLapidacao').value : ''),
                        furacao: (document.getElementById('tryoutFuracao') ? document.getElementById('tryoutFuracao').value : ''),
                        montagem: (document.getElementById('tryoutMontagem') ? document.getElementById('tryoutMontagem').value : ''),
                        serigrafia: (document.getElementById('tryoutSerigrafia') ? document.getElementById('tryoutSerigrafia').value : ''),
                        queima: (document.getElementById('tryoutQueima') ? document.getElementById('tryoutQueima').value : ''),
                        fornos: (document.getElementById('tryoutFornos') ? document.getElementById('tryoutFornos').value : '')
                    };
                } else if (taskKey === 'ferramental') {
                    // Recursos do Ferramental são datas - CORREÇÃO: usar toISODateString
                    resources = {
                        femea: toISODateString(document.getElementById('ferramentalFemea') ? document.getElementById('ferramentalFemea').value : ''),
                        gabaritoFanavid: toISODateString(document.getElementById('ferramentalGabaritoFanavid') ? document.getElementById('ferramentalGabaritoFanavid').value : ''),
                        gabaritoUsinado: toISODateString(document.getElementById('ferramentalGabaritoUsinado') ? document.getElementById('ferramentalGabaritoUsinado').value : ''),
                        matriz: toISODateString(document.getElementById('ferramentalMatriz') ? document.getElementById('ferramentalMatriz').value : ''),
                        macho: toISODateString(document.getElementById('ferramentalMacho') ? document.getElementById('ferramentalMacho').value : ''),
                        template: toISODateString(document.getElementById('ferramentalTemplate') ? document.getElementById('ferramentalTemplate').value : ''),
                        chapelona: toISODateString(document.getElementById('ferramentalChapelona') ? document.getElementById('ferramentalChapelona').value : ''),
                        plotter: toISODateString(document.getElementById('ferramentalPlotter') ? document.getElementById('ferramentalPlotter').value : ''),
                        tela: toISODateString(document.getElementById('ferramentalTela') ? document.getElementById('ferramentalTela').value : '')
                    };
                }

                tasks[taskKey] = {
                    planned: planned || null,
                    start: start || null,
                    executed: executed || null,
                    number: number || null,
                    quantidadeEntrada: quantidadeEntrada || null,
                    quantidadeSaida: quantidadeSaida || null,
                    resources: resources,
                    history: currentEditingProjectId ? 
                        (projects.find(p => p.id === currentEditingProjectId)?.tasks?.[taskKey]?.history || []) : []
                };
            });

            // Se status é automático, calcular com base nas tarefas
            if (statusSelectVal === 'automatico') {
                finalStatus = calculateProjectStatus({ tasks });
            }

            const leader = leaders.find(l => l.id == leaderId);
            const projectData = {
                cliente, projectName, segmento, leaderId, codigo, modelo, processo, fase, observacoes,
                projectLeader: leader ? leader.name : '',
                tasks,
                manualStatus: manualStatus
            };

            if (currentEditingProjectId) {
                const idx = projects.findIndex(p => p.id === currentEditingProjectId);
                if (idx >= 0) {
                    // manter createdAt se existir e aplicar o novo status final
                    projects[idx] = { ...projects[idx], ...projectData, status: finalStatus };
                    // Enviar atualização ao servidor em background
                    try{ pushProjectToServer(projects[idx]); }catch(e){console.warn(e)}
                }
            } else {
                // Novo projeto
                const newProject = {
                    id: nextProjectId++,
                    ...projectData,
                    status: finalStatus,
                    createdAt: new Date()
                };
                projects.push(newProject);
                try{ pushProjectToServer(newProject); }catch(e){console.warn(e)}
            }

            saveToLocalStorage();
            clearProjectForm();
            updateProjectsTable();
            updateSummary();
            document.getElementById('projectForm').style.display = 'none';
            currentEditingProjectId = null;
        }


        function editProject(id){
            showProjectForm(id);
        }

        function deleteProject(id){
            if(confirm('Tem certeza que deseja excluir este projeto?')){
                projects = projects.filter(p=>p.id!==id);
                saveToLocalStorage();
                clearProjectForm();
                updateProjectsTable();
                updateSummary();
                try{ deleteProjectOnServer(id); }catch(e){ console.warn(e); }
            }
        }

        // Formulário de líderes
        function showLeadersForm(){
            document.getElementById('projectForm').style.display = 'none';
            document.getElementById('leadersForm').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('leadersForm').scrollTop = 0;
        }

        function saveLeader(){
            const name = document.getElementById('newLeaderName').value.trim();
            const email = document.getElementById('newLeaderEmail').value.trim();
            const department = document.getElementById('newLeaderDepartment').value.trim();

            if(!name || !email || !department){
                alert('Preencha todos os campos do líder.');
                return;
            }

            leaders.push({id:nextLeaderId++, name, email, department});
            saveToLocalStorage();
            clearProjectForm();
            updateLeaderFilter();
            updateTaskLeaderFilter();
            updateProjectLeaderSelect();
            updateLeadersList();
            const newLeader = leaders[leaders.length-1];
            try{ pushLeaderToServer(newLeader); }catch(e){console.warn(e)}
            document.getElementById('leadersForm').reset();
        }

        function deleteLeader(id){
            if(projects.some(p=>p.leaderId==id)){
                alert('Não é possível excluir este líder pois existem projetos associados a ele.');
                return;
            }
            if(confirm('Tem certeza que deseja excluir este líder?')){
                leaders = leaders.filter(l=>l.id!==id);
                saveToLocalStorage();
                clearProjectForm();
                updateLeaderFilter();
                updateTaskLeaderFilter();
                updateProjectLeaderSelect();
                updateLeadersList();
            }
        }

        // ==============================================
        // NOVAS FUNÇÕES PARA HISTÓRICO EDITÁVEL
        // ==============================================
        function showHistoryModal(projectId, taskKey){
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            const task = project.tasks?.[taskKey];
            const history = task?.history || [];
            
            currentHistoryInfo = {
                projectId: projectId,
                taskKey: taskKey,
                editingIndex: null
            };
            
            const title = document.getElementById('historyModalTitle');
            title.textContent = `Histórico - ${taskKey.toUpperCase()} - ${project.projectName}`;
            
            renderHistoryList();
            document.getElementById('historyFormContainer').style.display = 'none';
            document.getElementById('historyModal').style.display = 'block';
        }

        function renderHistoryList(){
            const content = document.getElementById('historyContent');
            const { projectId, taskKey } = currentHistoryInfo;
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            
            const task = project.tasks?.[taskKey];
            const history = task?.history || [];
            
            content.innerHTML = '';
            
            if(history.length === 0){
                content.innerHTML = '<p style="text-align:center;padding:20px;">Nenhum histórico disponível.</p>';
                return;
            }
            
            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-content">
                        <div class="history-item-date">
                            <strong>Data:</strong> ${formatDateBR(item.date)}
                        </div>
                        <div class="history-item-reason">
                            <strong>Motivo:</strong> ${item.reason || ''}
                        </div>
                        <div class="history-item-dates">
                            <strong>De:</strong> ${formatDateBR(item.oldDate)} <strong>Para:</strong> ${formatDateBR(item.newDate)}
                        </div>
                    </div>
                    <div class="history-item-actions">
                        <button class="btn btn-primary btn-sm" onclick="editHistoryItem(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteHistoryItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                content.appendChild(historyItem);
            });
        }

        function editHistoryItem(index){
            const { projectId, taskKey } = currentHistoryInfo;
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            
            const task = project.tasks?.[taskKey];
            if(!task || !task.history || index >= task.history.length) return;
            
            const historyItem = task.history[index];
            
            currentHistoryInfo.editingIndex = index;
            
            // Preencher formulário com dados existentes
            document.getElementById('historyDate').value = toISODateString(historyItem.date);
            document.getElementById('historyReason').value = historyItem.reason || '';
            document.getElementById('historyOldDate').value = toISODateString(historyItem.oldDate);
            document.getElementById('historyNewDate').value = toISODateString(historyItem.newDate);
            
            document.getElementById('historyFormContainer').style.display = 'block';
            
            // Focar no primeiro campo
            document.getElementById('historyReason').focus();
        }

        function saveHistoryItem(){
            const { projectId, taskKey, editingIndex } = currentHistoryInfo;
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            
            if(!project.tasks) project.tasks = {};
            if(!project.tasks[taskKey]) project.tasks[taskKey] = {};
            if(!project.tasks[taskKey].history) project.tasks[taskKey].history = [];
            
            const date = document.getElementById('historyDate').value;
            const reason = document.getElementById('historyReason').value.trim();
            const oldDate = document.getElementById('historyOldDate').value;
            const newDate = document.getElementById('historyNewDate').value;
            
            if(!date || !reason || !oldDate || !newDate){
                alert('Preencha todos os campos do histórico.');
                return;
            }
            
            const historyItem = {
                date: date,
                reason: reason,
                oldDate: oldDate,
                newDate: newDate
            };
            
            if(editingIndex !== null && editingIndex < project.tasks[taskKey].history.length){
                // Atualizar item existente
                project.tasks[taskKey].history[editingIndex] = historyItem;
            } else {
                // Adicionar novo item
                project.tasks[taskKey].history.push(historyItem);
            }
            
            saveToLocalStorage();
            renderHistoryList();
            
            // Limpar formulário
            document.getElementById('historyFormContainer').style.display = 'none';
            
            // Atualizar badge do histórico na tabela principal
            updateProjectsTable();
        }

        function deleteHistoryItem(index){
            if(!confirm('Tem certeza que deseja excluir este histórico?')) return;
            
            const { projectId, taskKey } = currentHistoryInfo;
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            
            const task = project.tasks?.[taskKey];
            if(!task || !task.history || index >= task.history.length) return;
            
            task.history.splice(index, 1);
            
            saveToLocalStorage();
            renderHistoryList();
            
            // Atualizar badge do histórico na tabela principal
            updateProjectsTable();
        }

        function cancelHistoryEdit(){
            document.getElementById('historyFormContainer').style.display = 'none';
        }

        // Histórico and replanejamento
        function openRescheduleModal(projectId, taskKey){
            const project = projects.find(p=>p.id===projectId);
            if(!project) return;
            const task = project.tasks?.[taskKey];
            currentRescheduleInfo = {projectId, taskKey};
            document.getElementById('rescheduleTaskInfo').textContent = `Replanejar: ${taskKey.toUpperCase()} - ${project.projectName}`;
            document.getElementById('currentDate').value = formatDateBR(task?.planned) || 'Não definida';
            document.getElementById('newDate').value = toISODateString(task?.planned);
            document.getElementById('rescheduleReason').value = '';
            document.getElementById('rescheduleModal').style.display = 'block';
        }

        function saveReschedule(){
            if(!currentRescheduleInfo) return;
            const {projectId, taskKey} = currentRescheduleInfo;
            
            // CORREÇÃO: Usar toISODateString para garantir formato correto
            const newDate = toISODateString(document.getElementById('newDate').value);
            const reason = document.getElementById('rescheduleReason').value.trim();

            if(!newDate || !reason){
                alert('Preencha a nova data e o motivo do replanejamento.');
                return;
            }

            const project = projects.find(p => p.id === projectId);
            if(!project) return;
            if(!project.tasks) project.tasks = {};
            if(!project.tasks[taskKey]) project.tasks[taskKey] = {};
            
            // Adicionar ao histórico
            if(!project.tasks[taskKey].history) project.tasks[taskKey].history = [];
            project.tasks[taskKey].history.push({
                date: new Date(),
                reason,
                oldDate: project.tasks[taskKey].planned,
                newDate: newDate
            });

            // Atualizar data planejada
            project.tasks[taskKey].planned = newDate;
            
            // Recalcular status apenas se o projeto não estiver em modo manual
            if (!project.manualStatus) {
                project.status = calculateProjectStatus(project);
            }
            
            saveToLocalStorage();
            clearProjectForm();
            updateProjectsTable();
            updateSummary();
            document.getElementById('rescheduleModal').style.display = 'none';
            currentRescheduleInfo = null;
        }

        // ==============================================
        // FUNÇÕES DE EXPORT/IMPORT EXCEL
        // ==============================================
        function exportToExcel(){
            const data = projects.map(p=>{
                const row = {
                    'ID': p.id,
                    'Cliente': p.cliente,
                    'Projeto': p.projectName,
                    'Segmento': p.segmento,
                    'Líder': p.projectLeader,
                    'Código': p.codigo,
                    'Modelo': p.modelo,
                    'Processo': p.processo,
                    'Fase': p.fase,
                    'Status': p.status,
                    'Observações': p.observacoes
                };

                // Adicionar colunas para cada tarefa
                ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'].forEach(taskKey => {
                    const task = p.tasks?.[taskKey];
                    row[`${taskKey.toUpperCase()} Status`] = calculateTaskStatus(task, p.status);
                    row[`${taskKey.toUpperCase()} Planejado`] = formatDateBR(task?.planned);
                    row[`${taskKey.toUpperCase()} Início`] = formatDateBR(task?.start);
                    row[`${taskKey.toUpperCase()} Executado`] = formatDateBR(task?.executed);
                    if(taskKey === 'tryout' || taskKey === 'entrega') row[`${taskKey.toUpperCase()} Número`] = task?.number || '';
                    
                    // Adicionar quantidades para tryout
                    if (taskKey === 'tryout') {
                        row[`${taskKey.toUpperCase()} Quant. Entrada`] = task?.quantidadeEntrada || '';
                        row[`${taskKey.toUpperCase()} Quant. Saída`] = task?.quantidadeSaida || '';
                    }
                    
                    // Adicionar recursos para Try-out and Ferramental
                    if (taskKey === 'tryout') {
                        row[`${taskKey.toUpperCase()} Corte`] = task?.resources?.corte || '';
                        row[`${taskKey.toUpperCase()} Lapidação`] = task?.resources?.lapidacao || '';
                        row[`${taskKey.toUpperCase()} Furação/Rec`] = task?.resources?.furacao || '';
                        row[`${taskKey.toUpperCase()} Montagem`] = task?.resources?.montagem || '';
                        row[`${taskKey.toUpperCase()} Serigrafia`] = task?.resources?.serigrafia || '';
                        row[`${taskKey.toUpperCase()} Queima`] = task?.resources?.queima || '';
                        row[`${taskKey.toUpperCase()} Fornos`] = task?.resources?.fornos || '';
                    } else if (taskKey === 'ferramental') {
                        // Agora os recursos do Ferramental são datas
                        row[`${taskKey.toUpperCase()} Fêmea`] = formatDateBR(task?.resources?.femea) || '';
                        row[`${taskKey.toUpperCase()} Gabarito Fanavid`] = formatDateBR(task?.resources?.gabaritoFanavid) || '';
                        row[`${taskKey.toUpperCase()} Gabarito Usinado`] = formatDateBR(task?.resources?.gabaritoUsinado) || '';
                        row[`${taskKey.toUpperCase()} Matriz`] = formatDateBR(task?.resources?.matriz) || '';
                        row[`${taskKey.toUpperCase()} Macho`] = formatDateBR(task?.resources?.macho) || '';
                        row[`${taskKey.toUpperCase()} Template`] = formatDateBR(task?.resources?.template) || '';
                        row[`${taskKey.toUpperCase()} Chapelona`] = formatDateBR(task?.resources?.chapelona) || '';
                        row[`${taskKey.toUpperCase()} Plotter`] = formatDateBR(task?.resources?.plotter) || '';
                        row[`${taskKey.toUpperCase()} Tela`] = formatDateBR(task?.resources?.tela) || '';
                    }
                });

                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Projetos');
            XLSX.writeFile(wb, 'projetos.xlsx');
        }

        function importFromExcel(){
            document.getElementById('excelImportModal').style.display = 'block';
        }

        function handleExcelImport(){
            const fileInput = document.getElementById('excelFile');
            const overwrite = document.getElementById('importOverwrite').checked;
            
            if(!fileInput.files.length){
                alert('Selecione um arquivo Excel para importar.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e){
                try{
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if(overwrite){
                        projects = [];
                        nextProjectId = 1;
                    }
                    
                    jsonData.forEach(row=>{
                        // Mapear colunas do Excel para o formato interno
                        const project = {
                            id: nextProjectId++,
                            cliente: row.Cliente || '',
                            projectName: row.Projeto || '',
                            segmento: row.Segmento || '',
                            leaderId: leaders.find(l=>l.name===row.Líder)?.id || null,
                            projectLeader: row.Líder || '',
                            codigo: row.Código || '',
                            modelo: row.Modelo || '',
                            processo: row.Processo || '',
                            fase: row.Fase || '',
                            status: row.Status || 'Pendente',
                            observacoes: row.Observações || '',
                            tasks: {},
                            createdAt: new Date()
                        };
                        
                        // Processar tarefas
                        ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'].forEach(taskKey => {
                            const task = {
                                planned: parseExcelDate(row[`${taskKey.toUpperCase()} Planejado`]),
                                start: parseExcelDate(row[`${taskKey.toUpperCase()} Início`]),
                                executed: parseExcelDate(row[`${taskKey.toUpperCase()} Executado`]),
                                history: []
                            };
                            
                            if(taskKey === 'tryout' || taskKey === 'entrega') {
                                task.number = row[`${taskKey.toUpperCase()} Número`] || '';
                            }
                            
                            // Processar quantidades para tryout
                            if (taskKey === 'tryout') {
                                task.quantidadeEntrada = row[`${taskKey.toUpperCase()} Quant. Entrada`] || 0;
                                task.quantidadeSaida = row[`${taskKey.toUpperCase()} Quant. Saída`] || 0;
                            }
                            
                            // Processar recursos para Try-out and Ferramental
                            if (taskKey === 'tryout') {
                                task.resources = {
                                    corte: row[`${taskKey.toUpperCase()} Corte`] || '',
                                    lapidacao: row[`${taskKey.toUpperCase()} Lapidação`] || '',
                                    furacao: row[`${taskKey.toUpperCase()} Furação/Rec`] || '',
                                    montagem: row[`${taskKey.toUpperCase()} Montagem`] || '',
                                    serigrafia: row[`${taskKey.toUpperCase()} Serigrafia`] || '',
                                    queima: row[`${taskKey.toUpperCase()} Queima`] || '',
                                    fornos: row[`${taskKey.toUpperCase()} Fornos`] || ''
                                };
                            } else if (taskKey === 'ferramental') {
                                // Agora os recursos do Ferramental são datas
                                task.resources = {
                                    femea: parseExcelDate(row[`${taskKey.toUpperCase()} Fêmea`]),
                                    gabaritoFanavid: parseExcelDate(row[`${taskKey.toUpperCase()} Gabarito Fanavid`]),
                                    gabaritoUsinado: parseExcelDate(row[`${taskKey.toUpperCase()} Gabarito Usinado`]),
                                    matriz: parseExcelDate(row[`${taskKey.toUpperCase()} Matriz`]),
                                    macho: parseExcelDate(row[`${taskKey.toUpperCase()} Macho`]),
                                    template: parseExcelDate(row[`${taskKey.toUpperCase()} Template`]),
                                    chapelona: parseExcelDate(row[`${taskKey.toUpperCase()} Chapelona`]),
                                    plotter: parseExcelDate(row[`${taskKey.toUpperCase()} Plotter`]),
                                    tela: parseExcelDate(row[`${taskKey.toUpperCase()} Tela`])
                                };
                            }
                            
                            project.tasks[taskKey] = task;
                        });
                        
                        projects.push(project);
                    });
                    
                    saveToLocalStorage();
                    clearProjectForm();
                    updateProjectsTable();
                    updateSummary();
                    alert(`Importação concluída. ${jsonData.length} projetos importados.`);
                    document.getElementById('excelImportModal').style.display = 'none';
                }catch(error){
                    console.error('Erro na importação:', error);
                    alert('Erro ao importar arquivo. Verifique o formato.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // CORREÇÃO: Função para parse de datas do Excel
        function parseExcelDate(excelDate){
            if(!excelDate || excelDate === '-') return null;
            
            // Se for string no formato YYYY-MM-DD, retornar diretamente
            if (typeof excelDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(excelDate)) {
                return excelDate;
            }
            
            let date;
            if (typeof excelDate === 'number') {
                // Converter número serial do Excel para data JavaScript
                const excelEpoch = new Date(1900, 0, 1);
                date = new Date(excelEpoch.getTime() + (excelDate - 1) * 86400000);
            } else if (excelDate instanceof Date) {
                date = excelDate;
            } else if (typeof excelDate === 'string') {
                // Tentar parse de datas no formato brasileiro
                const parts = excelDate.split('/');
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    // Tentar parse ISO
                    date = new Date(excelDate);
                }
            } else {
                return null;
            }
            
            if (isNaN(date.getTime())) return null;
            
            // CORREÇÃO: Usar toISODateString para garantir formato correto
            return toISODateString(date);
        }

        // ==============================================
        // FUNÇÕES PARA CALCULAR EFICIÊNCIAS
        // ==============================================
        function calculateTasksEfficiency(projects) {
            if (!projects.length) return 0;
            
            let totalEfficiency = 0;
            let taskCount = 0;
            
            projects.forEach(project => {
                const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
                taskKeys.forEach(key => {
                    const task = project.tasks?.[key];
                    if (task) {
                        const efficiency = calculateTaskEfficiency(task);
                        // Só conta se a tarefa tem eficiência calculável (não é null)
                        if (efficiency !== null) {
                            totalEfficiency += efficiency;
                            taskCount++;
                        }
                    }
                });
            });
            
            return taskCount > 0 ? (totalEfficiency / taskCount) : 0;
        }

        function calculateTaskEfficiency(task) {
            if (!task) return null;
            
            const todayDate = today();
            const plannedDate = task.planned ? toDateOnly(task.planned) : null;
            const executedDate = task.executed ? toDateOnly(task.executed) : null;
            
            // Se a tarefa foi concluída
            if (executedDate) {
                if (!plannedDate) {
                    return 100; // Sem data planejada, consideramos 100%
                }
                // Concluída no prazo ou adiantada
                if (executedDate <= plannedDate) {
                    return 100;
                } else {
                    // Concluída com atraso - penalidade progressiva baseada no atraso
                    const delayDays = Math.floor((executedDate - plannedDate) / (1000 * 60 * 60 * 24));
                    const penalty = Math.min(delayDays * 5, 100); // Máximo 100% de penalidade
                    return Math.max(0, 100 - penalty);
                }
            } 
            // Tarefa não concluída
            else {
                // Se a tarefa não foi concluída e a data planejada já passou, está atrasada
                if (plannedDate && todayDate > plannedDate) {
                    const delayDays = Math.floor((todayDate - plannedDate) / (1000 * 60 * 60 * 24));
                    const penalty = Math.min(delayDays * 10, 100); // Penalidade mais severa para tarefas não concluídas
                    return Math.max(0, 100 - penalty);
                }
                // Caso contrário, ainda não é possível calcular a eficiência (não concluída e não atrasada)
                return null;
            }
        }

        function calculateProjectsEfficiency(projects) {
            if (!projects.length) return 0;
            
            const completedProjects = projects.filter(p => p.status === "Concluído").length;
            return (completedProjects / projects.length) * 100;
        }

        // ==============================================
        // FUNCIONALIDADE DE GRÁFICOS - MODIFICADA
        // ==============================================
        function initChartFilters() {
            // Inicializar os filtros dos gráficos
            const currentDate = new Date();
            document.getElementById('chartDateFrom').value = toISODateString(new Date(currentDate.getFullYear(), currentDate.getMonth(), 1));
            document.getElementById('chartDateTo').value = toISODateString(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0));
            
            // Configurar event listeners para os novos filtros
            setupChartAutoUpdate();
        }

        // Mostrar/ocultar seção de gráficos
        function showChartsSection() {
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('projectForm').style.display = 'none';
            document.getElementById('leadersForm').style.display = 'none';
            
            // Inicializar filtros dos gráficos se não estiverem inicializados
            initChartFilters();
            
            // Atualizar gráficos com os filtros atuais
            updateCharts();
        }

        function hideChartsSection() {
            document.getElementById('chartsSection').style.display = 'none';
        }

        // MODIFICADA: Aplicar filtros baseados em tarefas aos gráficos
        function getChartFilteredProjects() {
            const taskKey = document.getElementById('chartTaskFilter').value;
            const segment = document.getElementById('chartSegment').value;
            const dateFrom = document.getElementById('chartDateFrom').value;
            const dateTo = document.getElementById('chartDateTo').value;
            
            // Obter status de tarefa selecionados (múltiplos)
            const chartTaskStatusElements = document.getElementById('chartTaskStatus').selectedOptions;
            const chartTaskStatus = Array.from(chartTaskStatusElements).map(option => option.value);
            
            let filteredProjects = projects;
            
            // Aplicar filtro de segmento
            if (segment !== 'todos') {
                filteredProjects = filteredProjects.filter(p => p.segmento === segment);
            }
            
            // Se taskKey é 'todos', usar todos os projetos (já filtrados por segmento)
            // Se taskKey não é 'todos', filtrar por projetos que têm a tarefa especificada
            // MAS: O solicitante quer que os projetos que aparecem no gráfico de pizza 
            // (baseado no filtro de tarefa) também apareçam nos outros gráficos
            if (taskKey !== 'todos') {
                filteredProjects = filteredProjects.filter(p => {
                    const task = p.tasks?.[taskKey];
                    if (!task) return false;
                    
                    // Verificar status da tarefa (múltiplos)
                    if (chartTaskStatus.length > 0) {
                        const currentTaskStatus = calculateTaskStatus(task, p.status);
                        if (!chartTaskStatus.includes(currentTaskStatus)) return false;
                    }
                    
                    // CORREÇÃO: A data planejada da tarefa específica DEVE estar no período
                    // Isso garante que apenas projetos com a tarefa específica no período apareçam
                    if (dateFrom || dateTo) {
                        let dateInRange = false;
                        const fromDateObj = dateFrom ? toDateOnly(dateFrom) : null;
                        const toDateObj = dateTo ? toDateOnly(dateTo) : null;

                        // Apenas data planejada da tarefa específica
                        if(task.planned) {
                            const plannedDate = toDateOnly(task.planned);
                            if((!fromDateObj || compareDates(plannedDate, fromDateObj) >= 0) && 
                               (!toDateObj || compareDates(plannedDate, toDateObj) <= 0)) {
                                dateInRange = true;
                            }
                        }

                        if(!dateInRange) return false;
                    }
                    
                    return true;
                });
            } else {
                // Se taskKey é 'todos', ainda podemos filtrar por status de tarefa em qualquer tarefa
                if (chartTaskStatus.length > 0) {
                    filteredProjects = filteredProjects.filter(p => {
                        const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
                        return taskKeys.some(key => {
                            const task = p.tasks?.[key];
                            return task && calculateTaskStatus(task, p.status) === chartTaskStatus[0];
                        });
                    });
                }
                
                // Se há filtro de data quando taskKey é 'todos', considerar qualquer tarefa
                if (dateFrom || dateTo) {
                    filteredProjects = filteredProjects.filter(p => {
                        const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
                        return taskKeys.some(key => {
                            const task = p.tasks?.[key];
                            if (!task || !task.planned) return false;
                            
                            let dateInRange = false;
                            const fromDateObj = dateFrom ? toDateOnly(dateFrom) : null;
                            const toDateObj = dateTo ? toDateOnly(dateTo) : null;
                            
                            const plannedDate = toDateOnly(task.planned);
                            if((!fromDateObj || compareDates(plannedDate, fromDateObj) >= 0) && 
                               (!toDateObj || compareDates(plannedDate, toDateObj) <= 0)) {
                                dateInRange = true;
                            }
                            
                            return dateInRange;
                        });
                    });
                }
            }
            
            return filteredProjects;
        }

        // Atualizar gráficos com base nos filtros - MODIFICADO
        function updateCharts() {
            const taskKey = document.getElementById('chartTaskFilter').value;
            const segment = document.getElementById('chartSegment').value;
            const dateFrom = document.getElementById('chartDateFrom').value;
            const dateTo = document.getElementById('chartDateTo').value;
            
            // Obter status de tarefa selecionados
            const chartTaskStatusElements = document.getElementById('chartTaskStatus').selectedOptions;
            const chartTaskStatus = Array.from(chartTaskStatusElements).map(option => option.value);
            
            // Obter projetos filtrados
            let projectsForPeriod = getChartFilteredProjects();
            
            // Atualizar os gráficos com os projetos do período
            // CORREÇÃO: Verificar se os elementos canvas existem antes de renderizar
            if (document.getElementById('efficiencyChart')) {
                renderEfficiencyChart(projectsForPeriod, taskKey);
            }
            if (document.getElementById('projectStatusChart')) {
                renderProjectStatusChart(projectsForPeriod);
            }
            if (document.getElementById('leaderChart')) {
                renderLeaderChart(projectsForPeriod);
            }
            if (document.getElementById('segmentChart')) {
                renderSegmentChart(projectsForPeriod);
            }
            
            // Calcular eficiências específicas para o período
            let totalPlannedAll = 0;
            let totalExecutedAll = 0;
            let totalOnTimeAll = 0;
            
            const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
            taskKeys.forEach(key => {
                const stats = calculateTaskStatsForPeriod(projectsForPeriod, key);
                totalPlannedAll += stats.totalPlanned;
                totalExecutedAll += stats.totalExecuted;
                totalOnTimeAll += stats.totalOnTime;
            });
            
            const tasksCompletionRate = totalPlannedAll > 0 ? (totalExecutedAll / totalPlannedAll) * 100 : 0;
            const tasksEfficiencyRate = totalPlannedAll > 0 ? (totalOnTimeAll / totalPlannedAll) * 100 : 0;
            const projectsEfficiency = calculateProjectsEfficiency(projectsForPeriod);
            
            document.getElementById('periodTasksEfficiency').innerText = `${tasksEfficiencyRate.toFixed(1)}%`;
            document.getElementById('periodProjectsEfficiency').innerText = `${projectsEfficiency.toFixed(1)}%`;
            
            // Atualizar informação do período com dados mais detalhadas
            updatePeriodInfo(projectsForPeriod.length, taskKey, segment, dateFrom, dateTo, chartTaskStatus, totalPlannedAll, totalExecutedAll, totalOnTimeAll);
        }

        // Atualizar informação do período - MODIFICADO
        function updatePeriodInfo(projectCount, taskKey, segment, dateFrom, dateTo, taskStatus, totalPlanned, totalExecuted, totalOnTime) {
            const periodInfo = document.getElementById('periodInfoText');
            let infoText = `Mostrando ${projectCount} projetos`;
            
            if (taskKey !== 'todos') {
                infoText += ` | Tarefa: ${taskKey.toUpperCase()}`;
            }
            if (segment !== 'todos') {
                infoText += ` | Segmento: ${segment}`;
            }
            if (dateFrom || dateTo) {
                infoText += ` | Período: ${dateFrom ? formatDateBR(dateFrom) : 'Início'} a ${dateTo ? formatDateBR(dateTo) : 'Fim'}`;
            }
            if (taskStatus.length > 0) {
                infoText += ` | Status: ${taskStatus.join(', ')}`;
            }
            
            // Adicionar estatísticas detalhadas
            infoText += ` | Planejadas: ${totalPlanned} | Executadas: ${totalExecuted} | No prazo: ${totalOnTime}`;
            
            periodInfo.textContent = infoText;
        }

        // Configurar atualização automática dos gráficos
        function setupChartAutoUpdate() {
            // Atualizar gráficos quando os filtros mudarem
            document.getElementById('chartTaskFilter').addEventListener('change', updateCharts);
            document.getElementById('chartSegment').addEventListener('change', updateCharts);
            document.getElementById('chartDateFrom').addEventListener('change', updateCharts);
            document.getElementById('chartDateTo').addEventListener('change', updateCharts);
            document.getElementById('chartTaskStatus').addEventListener('change', updateCharts);
            
            // Atualizar gráficos quando o botão de aplicar for clicado
            document.getElementById('applyChartFilters').addEventListener('click', updateCharts);
        }

        // ==============================================
        // FUNCIONALIDADE DE ARQUIVO COMPARTILHADO
        // ==============================================
        function initSharedFileFeature() {
            // Verificar se há configuração de arquivo compartilhado
            sharedFilePath = localStorage.getItem('sharedFilePath') || '';
            syncIntervalTime = parseInt(localStorage.getItem('syncInterval')) || 30000;
            
            if (sharedFilePath) {
                startSync();
            }
        }

        function showSharedFileConfig() {
            document.getElementById('sharedFilePathInput').value = sharedFilePath;
            document.getElementById('syncIntervalInput').value = syncIntervalTime / 1000;
            document.getElementById('sharedFileModal').style.display = 'block';
        }

        function saveSharedFileConfig() {
            const path = document.getElementById('sharedFilePathInput').value.trim();
            const interval = parseInt(document.getElementById('syncIntervalInput').value) * 1000;
            
            if (!path) {
                alert('Informe o caminho do arquivo compartilhado.');
                return;
            }
            
            sharedFilePath = path;
            syncIntervalTime = interval;
            
            localStorage.setItem('sharedFilePath', sharedFilePath);
            localStorage.setItem('syncInterval', syncIntervalTime);
            
            // Reiniciar sincronização
            stopSync();
            startSync();
            
            alert('Configuração salva. Sincronização iniciada.');
            document.getElementById('sharedFileModal').style.display = 'none';
        }

        function startSync() {
            if (!sharedFilePath) return;
            
            // Tentar carregar dados do arquivo compartilhado
            loadSharedFile();
            
            // Configurar intervalo de sincronização
            syncInterval = setInterval(() => {
                loadSharedFile();
            }, syncIntervalTime);
            
            syncStatus = 'online';
            updateSummary();
        }

        function stopSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            syncStatus = 'offline';
            updateSummary();
        }

        function loadSharedFile() {
            if (!sharedFilePath || isSyncing) return;
            
            isSyncing = true;
            updateSyncIndicator(true);
            
            try {
                // Em um ambiente real, isso seria uma requisição para um servidor
                // ou leitura de um arquivo de rede
                const sharedData = localStorage.getItem('sharedFileData');
                
                if (sharedData) {
                    const data = JSON.parse(sharedData);
                    const dataHash = JSON.stringify(data);
                    
                    if (dataHash !== lastSyncHash) {
                        // Atualizar dados locais
                        projects = data.projects || projects;
                        leaders = data.leaders || leaders;
                        
                        // Recalcular IDs
                        if (projects.length) {
                            nextProjectId = Math.max(...projects.map(p => p.id)) + 1;
                        }
                        if (leaders.length) {
                            nextLeaderId = Math.max(...leaders.map(l => l.id)) + 1;
                        }
                        
                        saveToLocalStorage();
                        clearProjectForm();
                        updateProjectsTable();
                        updateSummary();
                        
                        lastSyncHash = dataHash;
                        
                        console.log('Dados sincronizados do arquivo compartilhado.');
                    }
                }
            } catch (error) {
                console.error('Erro na sincronização:', error);
                updateSyncIndicator(false, true);
            } finally {
                isSyncing = false;
                updateSyncIndicator(false, false);
            }
        }

        function saveSharedFile() {
            if (!sharedFilePath) {
                alert('Configure primeiro o caminho do arquivo compartilhado.');
                return;
            }
            
            isSyncing = true;
            updateSyncIndicator(true);
            
            try {
                const data = {
                    projects,
                    leaders,
                    lastSync: new Date()
                };
                
                // Em um ambiente real, isso seria uma requisição para um servidor
                // ou escrita em um arquivo de rede
                localStorage.setItem('sharedFileData', JSON.stringify(data));
                lastSyncHash = JSON.stringify(data);
                
                console.log('Dados salvos no arquivo compartilhado.');
            } catch (error) {
                console.error('Erro ao salvar no arquivo compartilhado:', error);
                updateSyncIndicator(false, true);
            } finally {
                isSyncing = false;
                updateSyncIndicator(false, false);
            }
        }

        function updateSyncIndicator(syncing, error = false) {
            let indicator = document.getElementById('syncIndicator');
            
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.id = 'syncIndicator';
                indicator.className = 'sync-indicator';
                document.getElementById('syncStatus').parentNode.appendChild(indicator);
            }
            
            if (syncing) {
                indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> Sincronizando...';
                indicator.className = 'sync-indicator syncing';
            } else if (error) {
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro na sincronização';
                indicator.className = 'sync-indicator error';
            } else {
                indicator.innerHTML = '<i class="fas fa-check-circle"></i> Sincronizado';
                indicator.className = 'sync-indicator';
            }
        }

        // ==============================================
        // FUNÇÕES AUXILIARES
        // ==============================================
        function clearProjectForm() {
            document.querySelectorAll('#projectForm input, #projectForm select, #projectForm textarea')
                .forEach(el => {
                    if(el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                });
        }

        // ==============================================
        // NOVAS FUNÇÕES PARA CLIQUE NOS GRÁFICOS
        // ==============================================

        // NOVA FUNÇÃO: Mostrar projetos em modal
        function showProjectsModal(projectsList, title, taskKey = null) {
            const modal = document.getElementById('projectListModal');
            const modalTitle = document.getElementById('projectListModalTitle');
            const modalContent = document.getElementById('projectListModalContent');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            
            if (!projectsList || projectsList.length === 0) {
                modalContent.innerHTML = '<p>Nenhum projeto encontrado.</p>';
                modal.style.display = 'block';
                return;
            }
            
            // Determinar se devemos mostrar a coluna de status da tarefa específica
            const showTaskStatus = taskKey !== null;
            
            const table = document.createElement('table');
            table.className = 'task-table';
            
            // Cabeçalho da tabela
            let tableHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Projeto</th>
                        <th>Cliente</th>
                        <th>Segmento</th>
                        <th>Status do Projeto</th>
            `;
            
            // Adicionar coluna de status da tarefa específica se necessário
            if (showTaskStatus) {
                tableHTML += `<th>Status da Tarefa (${taskKey.toUpperCase()})</th>`;
            }
            
            tableHTML += `
                        <th>Líder</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Linhas da tabela
            projectsList.forEach(project => {
                const projectStatus = project.status;
                let taskStatus = '';
                
                // Calcular status da tarefa específica se necessário
                if (showTaskStatus) {
                    const task = project.tasks?.[taskKey];
                    taskStatus = calculateTaskStatus(task, project.status);
                }
                
                tableHTML += `
                    <tr>
                        <td>${project.id}</td>
                        <td>${project.projectName || '-'}</td>
                        <td>${project.cliente || '-'}</td>
                        <td>${project.segmento || '-'}</td>
                        <td><span class="status status-${projectStatus.toLowerCase().replace(/\s/g,'-')}">${projectStatus}</span></td>
                `;
                
                // Adicionar célula de status da tarefa específica se necessário
                if (showTaskStatus) {
                    tableHTML += `<td><span class="status status-${taskStatus.toLowerCase().replace(/\s/g,'-')}">${taskStatus}</span></td>`;
                }
                
                tableHTML += `
                        <td>${project.projectLeader || '-'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            modalContent.appendChild(table);
            modal.style.display = 'block';
        }

        // ==============================================
        // EVENT LISTENERS - MODIFICADOS PARA INCLUIR TOGGLE DE FILTROS
        // ==============================================
        function setupEventListeners(){
            // Botões principais
            document.getElementById('addProjectBtn').addEventListener('click',()=>showProjectForm());
            document.getElementById('manageLeadersBtn').addEventListener('click',showLeadersForm);
            document.getElementById('saveDataBtn').addEventListener('click',saveToLocalStorage);
            document.getElementById('loadDataBtn').addEventListener('click',loadFromLocalStorage);
            document.getElementById('exportExcelBtn').addEventListener('click',exportToExcel);
            document.getElementById('importExcelBtn').addEventListener('click',importFromExcel);
            document.getElementById('sharedFileBtn').addEventListener('click',showSharedFileConfig);
            document.getElementById('syncBtn').addEventListener('click',saveSharedFile);
            // Também sincroniza dados do banco quando clicar em Sincronizar
            document.getElementById('syncBtn').addEventListener('click', atualizarDadosDoBanco);
            document.getElementById('showChartsBtn').addEventListener('click',showChartsSection);
            document.getElementById('closeChartsBtn').addEventListener('click',hideChartsSection);
            
            // Botão para mostrar/ocultar filtros (APENAS O DO CABEÇALHO)
            document.getElementById('toggleFiltersBtn').addEventListener('click', function() {
                const container = document.getElementById('filtersContainer');
                const button = this;
                
                if (container.classList.contains('show')) {
                    container.classList.remove('show');
                    button.innerHTML = '<i class="fas fa-filter"></i> Mostrar Filtros';
                } else {
                    container.classList.add('show');
                    button.innerHTML = '<i class="fas fa-times"></i> Ocultar Filtros';
                }
            });
            
            // Formulário de projeto
            document.getElementById('saveProjectBtn').addEventListener('click',saveProject);
            document.getElementById('cancelProjectBtn').addEventListener('click',()=>{
                document.getElementById('projectForm').style.display='none';
                currentEditingProjectId=null;
            });
            
            // Event listener para mudança no status do projeto
            document.getElementById('projectStatusSelect').addEventListener('change', function() {
                const projectStatus = this.value;
                updateAllTaskStatusesDisplay(projectStatus);
            });
            
            // Formulário de líderes
            document.getElementById('addLeaderBtn').addEventListener('click',saveLeader);
            document.getElementById('cancelLeaderBtn').addEventListener('click',()=>{
                document.getElementById('leadersForm').style.display='none';
            });
            
            // Filtros
            document.querySelectorAll('#idFilter, #projectFilter, #segmentoFilter, #leaderFilter, #search').forEach(el=>{
                el.addEventListener('input',()=>{
                    updateProjectsTable();
                    updateSummary();
                });
            });
            
            // Filtro de status múltiplo
            document.getElementById('statusFilter').addEventListener('change',()=>{
                updateProjectsTable();
                updateSummary();
            });
            
            // Filtros de data
            document.getElementById('applyDateFilterBtn').addEventListener('click',()=>{
                updateProjectsTable();
                updateSummary();
                countFilteredProjectsByTask();
            });
            
            document.getElementById('clearDateFilterBtn').addEventListener('click',()=>{
                document.getElementById('dateFilterType').value='todos';
                document.getElementById('dateFilterFrom').value='';
                document.getElementById('dateFilterTo').value='';
                clearAllTaskStatuses();
                document.getElementById('taskSegmentoFilter').value='todos';
                document.getElementById('taskLeaderFilter').value='todos';
                updateProjectsTable();
                updateSummary();
                countFilteredProjectsByTask();
            });
            
            // NOVO: Adicionar event listeners para filtros de tarefa
            document.getElementById('dateFilterType').addEventListener('change', countFilteredProjectsByTask);
            document.getElementById('taskSegmentoFilter').addEventListener('change', countFilteredProjectsByTask);
            document.getElementById('taskLeaderFilter').addEventListener('change', countFilteredProjectsByTask);
            document.getElementById('dateFilterFrom').addEventListener('change', countFilteredProjectsByTask);
            document.getElementById('dateFilterTo').addEventListener('change', countFilteredProjectsByTask);
            document.getElementById('taskStatusFilter').addEventListener('change', countFilteredProjectsByTask);
            
            // Modal de replanejamento
            document.getElementById('saveRescheduleBtn').addEventListener('click',saveReschedule);
            document.getElementById('cancelRescheduleBtn').addEventListener('click',()=>{
                document.getElementById('rescheduleModal').style.display='none';
                currentRescheduleInfo=null;
            });
            
            // Modal de importação Excel
            document.getElementById('confirmImportBtn').addEventListener('click',handleExcelImport);
            document.getElementById('cancelImportBtn').addEventListener('click',()=>{
                document.getElementById('excelImportModal').style.display='none';
            });
            
            // Configuração de arquivo compartilhado
            document.getElementById('saveSharedFileBtn').addEventListener('click',saveSharedFileConfig);
            document.getElementById('cancelSharedFileBtn').addEventListener('click',()=>{
                document.getElementById('sharedFileModal').style.display='none';
            });
            
            // NOVO: Event listeners para histórico editável
            document.getElementById('saveHistoryBtn').addEventListener('click', saveHistoryItem);
            document.getElementById('cancelHistoryBtn').addEventListener('click', cancelHistoryEdit);
            
            // Fechar modais
            document.querySelectorAll('.close').forEach(closeBtn=>{
                closeBtn.addEventListener('click',function(){
                    const modalId = this.getAttribute('data-close');
                    document.getElementById(modalId).style.display='none';
                });
            });
            
            // Fechar modais clicando fora
            window.addEventListener('click',function(event){
                document.querySelectorAll('.modal').forEach(modal=>{
                    if(event.target===modal){
                        modal.style.display='none';
                    }
                });
            });
            
            // Atualizar status das tarefas quando as datas mudarem
            const taskKeys = ['kom','ferramental','cadBomFt','tryout','entrega','psw','handover'];
            taskKeys.forEach(taskKey => {
                ['Planned','Start','Executed'].forEach(dateType => {
                    const input = document.getElementById(`${taskKey}${dateType}`);
                    if (input) {
                        input.addEventListener('change', function() {
                            const projectStatus = document.getElementById('projectStatusSelect').value;
                            // Criar um objeto task com os dados atuais
                            const task = {
                                planned: document.getElementById(`${taskKey}Planned`).value,
                                start: document.getElementById(`${taskKey}Start`).value,
                                executed: document.getElementById(`${taskKey}Executed`).value
                            };
                            updateTaskStatusDisplay(taskKey, task, projectStatus);
                        });
                    }
                });
            });
        }

        // ==============================================
        // INICIALIZAÇÃO
        // ==============================================
        function initApp(){
            try {
                loadFromLocalStorage();
                updateLeaderFilter();
                updateTaskLeaderFilter();
                updateProjectLeaderSelect();
                updateLeadersList();
                updateProjectsTable();
                updateSummary();
                
                // CORREÇÃO CRÍTICA: Chamar setupEventListeners
                setupEventListeners();
                
                initChartFilters();
                
                // Inicializar funcionalidade de arquivo compartilhado
                initSharedFileFeature();
                
                // Inicializar contador de projetos filtrados por tarefa
                countFilteredProjectsByTask();
                // Carregar dados do banco em background (DB é fonte primária)
                setTimeout(()=>{ atualizarDadosDoBanco(); }, 500);
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Erro ao inicializar a aplicação: ' + error.message);
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', initApp);

        // ==============================================
        // FUNÇÕES PARA RENDERIZAR GRÁFICOS
        // ==============================================

        // NOVAS FUNÇÕES PARA CÁLCULO ESPECÍFICO POR PERÍODO
        function calculateTaskStatsForPeriod(projectsForPeriod, taskKey) {
            let totalPlannedInPeriod = 0;
            let totalExecutedInPeriod = 0;
            let totalExecutedOnTime = 0;

            projectsForPeriod.forEach(project => {
                const task = project.tasks?.[taskKey];
                if (task && task.planned) {
                    const plannedDate = toDateOnly(task.planned);
                    const executedDate = task.executed ? toDateOnly(task.executed) : null;
                    
                    // Verificar se a tarefa foi planejada no período selecionado
                    const chartDateFrom = document.getElementById('chartDateFrom').value ? toDateOnly(document.getElementById('chartDateFrom').value) : null;
                    const chartDateTo = document.getElementById('chartDateTo').value ? toDateOnly(document.getElementById('chartDateTo').value) : null;
                    
                    let isInPeriod = true;
                    if (chartDateFrom && plannedDate < chartDateFrom) {
                        isInPeriod = false;
                    }
                    if (chartDateTo && plannedDate > chartDateTo) {
                        isInPeriod = false;
                    }
                    
                    if (isInPeriod) {
                        totalPlannedInPeriod++;
                        
                        // Verificar se foi executada no período
                        if (executedDate) {
                            totalExecutedInPeriod++;
                            
                            // Verificar se foi executada na data planejada ou antes
                            if (executedDate <= plannedDate) {
                                totalExecutedOnTime++;
                            }
                        }
                    }
                }
            });

            const completionRate = totalPlannedInPeriod > 0 ? (totalExecutedInPeriod / totalPlannedInPeriod) * 100 : 0;
            const efficiencyRate = totalPlannedInPeriod > 0 ? (totalExecutedOnTime / totalPlannedInPeriod) * 100 : 0;

            return {
                totalPlanned: totalPlannedInPeriod,
                totalExecuted: totalExecutedInPeriod,
                totalOnTime: totalExecutedOnTime,
                completionRate: completionRate,
                efficiencyRate: efficiencyRate
            };
        }

        // Renderizar gráfico de eficiência para todas as tarefas
        function renderEfficiencyChart(projectsForPeriod, taskKey) {
            const ctx = document.getElementById('efficiencyChart');
            if (!ctx) return;
            
            // Calcular eficiência de todas as tarefas nos projetos do período
            const taskKeys = ['kom', 'ferramental', 'cadBomFt', 'tryout', 'entrega', 'psw', 'handover'];
            const taskLabels = ['KOM', 'Ferramental', 'CAD+BOM+FT', 'Try-out', 'Entrega', 'PSW', 'Handover'];
            
            const completionRates = [];
            const efficiencyRates = [];
            const labels = [];
            const backgroundColors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(201, 203, 207, 0.7)',
                'rgba(255, 205, 86, 0.7)'
            ];
            
            // Arrays para armazenar os dados dos labels
            const plannedTasks = [];
            const executedTasks = [];
            const onTimeTasks = [];
            const labelTextsCompletion = [];
            const labelTextsEfficiency = [];
            
            taskKeys.forEach((taskKey, index) => {
                const stats = calculateTaskStatsForPeriod(projectsForPeriod, taskKey);
                completionRates.push(stats.completionRate);
                efficiencyRates.push(stats.efficiencyRate);
                labels.push(taskLabels[index]);
                plannedTasks.push(stats.totalPlanned);
                executedTasks.push(stats.totalExecuted);
                onTimeTasks.push(stats.totalOnTime);
                
                // Criar textos dos labels
                labelTextsCompletion.push(`${stats.totalExecuted}/${stats.totalPlanned}\n(${stats.completionRate.toFixed(0)}%)`);
                labelTextsEfficiency.push(`${stats.totalOnTime}/${stats.totalPlanned}\n(${stats.efficiencyRate.toFixed(0)}%)`);
            });
            
            // Destruir o gráfico anterior se existir
            if (efficiencyChart) {
                efficiencyChart.destroy();
            }
            
            // Calcular eficiência geral para o período
            const totalEfficiency = efficiencyRates.reduce((sum, rate) => sum + rate, 0) / efficiencyRates.length;
            document.getElementById('efficiencyValue').textContent = `${totalEfficiency.toFixed(1)}%`;
            
            efficiencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Taxa de Conclusão (%)',
                            data: completionRates,
                            backgroundColor: backgroundColors.map(color => color.replace('0.7', '0.6')),
                            borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Eficiência Real (%)',
                            data: efficiencyRates,
                            backgroundColor: backgroundColors.map(color => color.replace('0.7', '0.9')),
                            borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Comparativo de Conclusão vs Eficiência`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const datasetIndex = context.datasetIndex;
                                    
                                    if (datasetIndex === 0) {
                                        return `Concluídas: ${executedTasks[index]}/${plannedTasks[index]} | Taxa: ${completionRates[index].toFixed(1)}%`;
                                    } else {
                                        return `No prazo: ${onTimeTasks[index]}/${plannedTasks[index]} | Eficiência: ${efficiencyRates[index].toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: function(context) {
                                return context.datasetIndex === 0 ? 'white' : 'black';
                            },
                            font: {
                                weight: 'bold',
                                size: 10
                            },
                            formatter: function(value, context) {
                                if (context.datasetIndex === 0) {
                                    return labelTextsCompletion[context.dataIndex];
                                } else {
                                    return labelTextsEfficiency[context.dataIndex];
                                }
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const taskName = taskLabels[index];
                            const taskKeyName = taskKeys[index];
                            
                            // Filtrar projetos que têm a tarefa específica
                            const taskProjectsList = projectsForPeriod.filter(p => {
                                const task = p.tasks?.[taskKeyName];
                                return task && task.planned; // Que têm essa tarefa planejada
                            });
                            
                            // MODIFICAÇÃO: Passar taskKeyName como terceiro parâmetro
                            showProjectsModal(taskProjectsList, `Projetos com Tarefa: ${taskName}`, taskKeyName);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Gráfico de status dos projetos - MODIFICADO para incluir "Em Espera" e "Cancelado"
        function renderProjectStatusChart(projectsForPeriod) {
            const ctx = document.getElementById('projectStatusChart');
            if (!ctx) return;
            
            const statusCounts = {
                'Concluído': 0,
                'No Prazo': 0,
                'Em Andamento': 0,
                'Atrasado': 0,
                'Pendente': 0,
                'Em Espera': 0,
                'Cancelado': 0
            };
            
            projectsForPeriod.forEach(p => {
                statusCounts[p.status] = (statusCounts[p.status] || 0) + 1;
            });
            
            // Calcular percentual de projetos concluídos
            const totalProjects = projectsForPeriod.length;
            const completedProjects = statusCounts['Concluído'] || 0;
            const completedPercentage = totalProjects > 0 ? (completedProjects / totalProjects) * 100 : 0;
            
            document.getElementById('completedProjectsValue').textContent = `${completedPercentage.toFixed(1)}%`;
            
            // Destruir gráfico anterior se existir
            if (projectStatusChart) {
                projectStatusChart.destroy();
            }
            
            // CORES
            const backgroundColorMap = {
                'Concluído': 'rgba(75, 192, 192, 0.7)',
                'No Prazo': 'rgba(255, 206, 86, 0.7)',
                'Em Andamento': 'rgba(54, 162, 235, 0.7)',
                'Atrasado': 'rgba(255, 99, 132, 0.7)',
                'Pendente': 'rgba(201, 203, 207, 0.7)',
                'Em Espera': 'rgba(255, 152, 0, 0.7)',
                'Cancelado': 'rgba(158, 158, 158, 0.7)'
            };
            
            const borderColorMap = {
                'Concluído': 'rgba(75, 192, 192, 1)',
                'No Prazo': 'rgba(255, 206, 86, 1)',
                'Em Andamento': 'rgba(54, 162, 235, 1)',
                'Atrasado': 'rgba(255, 99, 132, 1)',
                'Pendente': 'rgba(201, 203, 207, 1)',
                'Em Espera': 'rgba(255, 152, 0, 1)',
                'Cancelado': 'rgba(158, 158, 158, 1)'
            };
            
            // Filtrar apenas status que têm projetos
            const activeStatuses = Object.keys(statusCounts).filter(status => statusCounts[status] > 0);
            
            projectStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: activeStatuses.map(status => `${status} (${statusCounts[status]})`),
                    datasets: [{
                        data: activeStatuses.map(status => statusCounts[status]),
                        backgroundColor: activeStatuses.map(status => backgroundColorMap[status]),
                        borderColor: activeStatuses.map(status => borderColorMap[status]),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Status dos Projetos - Total: ${projectsForPeriod.length}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label.replace(` (${value})`, '')}: ${value} projetos (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return percentage + '%';
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const statusName = activeStatuses[index];
                            const statusProjectsList = projectsForPeriod.filter(p => p.status === statusName);
                            // MODIFICAÇÃO: Não passar taskKey (ou passar null) para este modal
                            showProjectsModal(statusProjectsList, `Projetos com Status: ${statusName}`);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Gráfico de eficiência por líder
        function renderLeaderChart(projectsForPeriod) {
            const ctx = document.getElementById('leaderChart');
            if (!ctx) return;
            
            const leaderStats = {};
            const labelTexts = [];
            
            // Agrupar projetos por líder e contar concluídos vs totais
            projectsForPeriod.forEach(project => {
                if (project.leaderId) {
                    const leader = leaders.find(l => l.id == project.leaderId);
                    if (leader) {
                        if (!leaderStats[leader.name]) {
                            leaderStats[leader.name] = {
                                total: 0,
                                completed: 0
                            };
                        }
                        leaderStats[leader.name].total++;
                        if (project.status === "Concluído") {
                            leaderStats[leader.name].completed++;
                        }
                    }
                }
            });
            
            // Calcular eficiência para cada líder: (concluídos / totais) * 100
            const leaderNames = Object.keys(leaderStats);
            const efficiencies = [];
            const completedCounts = [];
            const totalCounts = [];
            
            leaderNames.forEach(leaderName => {
                const stats = leaderStats[leaderName];
                const efficiency = stats.total > 0 ? (stats.completed / stats.total) * 100 : 0;
                efficiencies.push(efficiency);
                completedCounts.push(stats.completed);
                totalCounts.push(stats.total);
                
                // Criar texto do label: "X/Y (Z%)"
                labelTexts.push(`${stats.completed}/${stats.total}\n(${efficiency.toFixed(0)}%)`);
            });
            
            // Destruir gráfico anterior se existir
            if (leaderChart) {
                leaderChart.destroy();
            }
            
            // Se não há líderes com projetos, mostrar mensagem
            if (leaderNames.length === 0) {
                ctx.parentElement.innerHTML = '<div class="chart-title">Eficiência por Líder (Concluído / Planejado)</div><p style="text-align:center;padding:20px">Nenhum dado disponível para os filtros selecionados</p>';
                leaderChart = null;
                return;
            }
            
            leaderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: leaderNames,
                    datasets: [{
                        label: 'Eficiência de Projetos (%)',
                        data: efficiencies,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Eficiência por Líder (Concluído / Planejado)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Eficiência: ${context.raw.toFixed(1)}%`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Projetos concluídos: ${completedCounts[index]}/${totalCounts[index]}`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                return labelTexts[context.dataIndex];
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const leaderName = leaderNames[index];
                            const leaderProjectsList = projectsForPeriod.filter(p => {
                                const leader = leaders.find(l => l.id == p.leaderId);
                                return leader && leader.name === leaderName;
                            });
                            showProjectsModal(leaderProjectsList, `Projetos do Líder: ${leaderName}`);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Gráfico de eficiência por segmento
        function renderSegmentChart(projectsForPeriod) {
            const ctx = document.getElementById('segmentChart');
            if (!ctx) return;
            
            const segments = ['Blindados', 'Autos', 'Agrícola', 'Ônibus & Caminhões', 'Trens'];
            const segmentStats = {};
            const labelTexts = [];
            
            // Inicializar estatísticas para cada segmento
            segments.forEach(segment => {
                segmentStats[segment] = {
                    total: 0,
                    completed: 0
                };
            });
            
            // Contar projetos por segmento (concluídos vs totais)
            projectsForPeriod.forEach(project => {
                if (project.segmento && segments.includes(project.segmento)) {
                    segmentStats[project.segmento].total++;
                    if (project.status === "Concluído") {
                        segmentStats[project.segmento].completed++;
                    }
                }
            });
            
            // Calcular eficiência para cada segmento: (concluídos / totais) * 100
            const segmentNames = [];
            const efficiencies = [];
            const completedCounts = [];
            const totalCounts = [];
            
            segments.forEach(segment => {
                if (segmentStats[segment].total > 0) {
                    const stats = segmentStats[segment];
                    const efficiency = stats.total > 0 ? (stats.completed / stats.total) * 100 : 0;
                    segmentNames.push(segment);
                    efficiencies.push(efficiency);
                    completedCounts.push(stats.completed);
                    totalCounts.push(stats.total);
                    
                    // Criar texto do label: "X/Y (Z%)"
                    labelTexts.push(`${stats.completed}/${stats.total}\n(${efficiency.toFixed(0)}%)`);
                }
            });
            
            // Destruir gráfico anterior se existir
            if (segmentChart) {
                segmentChart.destroy();
            }
            
            segmentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: segmentNames,
                    datasets: [{
                        label: 'Eficiência de Projetos (%)',
                        data: efficiencies,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Eficiência por Segmento (Concluído / Planejado)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Eficiência: ${context.raw.toFixed(1)}%`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Projetos concluídos: ${completedCounts[index]}/${totalCounts[index]}`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                return labelTexts[context.dataIndex];
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const segmentName = segmentNames[index];
                            const segmentProjectsList = projectsForPeriod.filter(p => p.segmento === segmentName);
                            showProjectsModal(segmentProjectsList, `Projetos do Segmento: ${segmentName}`);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    </script>
</body>
</html>